<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Canadian Fitness Repair</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --dark-bg: #121826;
            --dark-card: #1f2937;
            --dark-border: #374151;
            --dark-text: #e5e7eb;
            --dark-accent: #3b82f6;
            --dark-hover: #4b5563;
            --dark-success: #10b981;
            --dark-warning: #f59e0b;
            --dark-danger: #ef4444;
            --dark-gray: #9ca3af;
            --dark-highlight: #1e40af;
            --dark-shadow: rgba(0, 0, 0, 0.4);
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark-card);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 100;
            border-right: 1px solid var(--dark-border);
            box-shadow: 0 0 20px var(--dark-shadow);
        }
        
        .brand {
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .brand h2 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .brand i {
            font-size: 1.8rem;
            color: var(--dark-accent);
        }
        
        .nav-links {
            padding: 20px 0;
        }
        
        .nav-links a {
            display: flex;
            align-items: center;
            padding: 16px 30px;
            color: var(--dark-gray);
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
            font-weight: 500;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--dark-accent);
            border-left: 4px solid var(--dark-accent);
        }
        
        .nav-links a i {
            margin-right: 15px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            transition: var(--transition);
        }
        
        .nav-links a.active i, .nav-links a:hover i {
            transform: scale(1.1);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 25px;
            padding-top: 90px;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px var(--dark-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 90;
            border-bottom: 1px solid var(--dark-border);
        }
        
        .header h2 {
            font-weight: 600;
            font-size: 1.4rem;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--dark-accent), #7c3aed);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .tabs {
            display: flex;
            background: var(--dark-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--dark-shadow);
            margin-bottom: 30px;
            border: 1px solid var(--dark-border);
        }
        
        .tab {
            padding: 16px 25px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            text-align: center;
            flex: 1;
            color: var(--dark-gray);
            position: relative;
            overflow: hidden;
        }
        
        .tab.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            color: var(--dark-accent);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            background: var(--dark-card);
            border-radius: 16px;
            box-shadow: 0 8px 30px var(--dark-shadow);
            margin-bottom: 35px;
            border: 1px solid var(--dark-border);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.7), rgba(17, 24, 39, 0.7));
            border-radius: 16px;
            padding: 25px;
            transition: var(--transition);
            border: 1px solid var(--dark-border);
            box-shadow: 0 8px 20px var(--dark-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(59, 130, 246, 0.15);
            color: var(--dark-accent);
        }
        
        .card-content {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-text);
            margin: 10px 0;
        }
        
        .card-footer {
            font-size: 0.9rem;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-footer i {
            color: var(--dark-success);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px var(--dark-shadow);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid var(--dark-border);
        }
        
        th {
            background-color: rgba(31, 41, 55, 0.8);
            font-weight: 600;
            color: var(--dark-accent);
            position: sticky;
            top: 0;
        }
        
        tr {
            transition: var(--transition);
        }
        
        tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .action-btn {
            background: rgba(59, 130, 246, 0.1);
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: var(--transition);
            color: var(--dark-accent);
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }
        
        .action-btn.delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--dark-danger);
        }
        
        .action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-scheduled {
            background: rgba(93, 93, 255, 0.15);
            color: #5d5dff;
        }
        
        .status-draft {
            background: rgba(149, 165, 166, 0.15);
            color: #95a5a6;
        }
        
        .status-released {
            background: rgba(46, 204, 113, 0.15);
            color: #2ecc71;
        }
        
        .status-inprogress {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }
        
        .status-cancelled {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }
        
        .status-warning {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        
        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 12px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 15px 10px;
            font-weight: 600;
            background: var(--dark-card);
            border-radius: 12px;
            color: var(--dark-accent);
            border: 1px solid var(--dark-border);
        }
        
        .calendar-day {
            min-height: 120px;
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.7), rgba(17, 24, 39, 0.7));
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 10px var(--dark-shadow);
            transition: var(--transition);
        }
        
        .calendar-day:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }
        
        .calendar-day.empty {
            background: transparent;
            box-shadow: none;
            border: none;
        }
        
        .day-number {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark-text);
            font-size: 1.1rem;
        }
        
        .appointment-item {
            background: rgba(59, 130, 246, 0.15);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--dark-accent);
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid var(--dark-accent);
        }
        
        .appointment-item:hover {
            background: rgba(59, 130, 246, 0.25);
        }
        
        .btn {
            padding: 12px 22px;
            background: linear-gradient(90deg, var(--dark-accent), #7c3aed);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.secondary {
            background: var(--dark-card);
            color: var(--dark-gray);
            box-shadow: 0 4px 15px var(--dark-shadow);
        }
        
        .btn.secondary:hover {
            background: var(--dark-hover);
            color: var(--dark-text);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 28px;
            border-radius: 12px;
            background: var(--dark-card);
            color: white;
            z-index: 1000;
            box-shadow: 0 8px 25px var(--dark-shadow);
            opacity: 0;
            transform: translateY(-30px);
            transition: var(--transition);
            border: 1px solid var(--dark-border);
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 350px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.error {
            border-left: 4px solid var(--dark-danger);
        }
        
        .toast.success {
            border-left: 4px solid var(--dark-success);
        }
        
        .toast i {
            font-size: 1.4rem;
        }
        
        .toast.success i {
            color: var(--dark-success);
        }
        
        .toast.error i {
            color: var(--dark-danger);
        }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(18, 24, 38, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            flex-direction: column;
            display: none;
        }
        
        #loading-overlay .spinner {
            font-size: 3.5rem;
            margin-bottom: 25px;
            animation: spin 1.2s linear infinite;
            color: var(--dark-accent);
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--dark-card);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px var(--dark-shadow);
            border: 1px solid var(--dark-border);
            position: relative;
            padding: 35px;
            animation: modalIn 0.4s ease;
        }
.skeleton-row {
  display: flex;
  gap: 10px;
  padding: 12px;
  animation: pulse 1.5s infinite;
}

.skeleton-cell {
  height: 20px;
  background: #2d3748;
  border-radius: 4px;
  flex: 1;
}
.validation-error {
    color: var(--dark-danger);
    font-size: 0.85rem;
    margin-top: 5px;
    min-height: 20px;
}

.form-control.invalid {
    border-color: var(--dark-danger);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}
@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 0.3; }
  100% { opacity: 0.6; }
}
        
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .close-modal {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 1.8rem;
            color: var(--dark-gray);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close-modal:hover {
            color: var(--dark-danger);
            transform: rotate(90deg);
        }
        
        .modal h2 {
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal h2 i {
            color: var(--dark-accent);
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            color: var(--dark-text);
            font-size: 1rem;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--dark-accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar .brand h2, .sidebar .nav-links a span {
                display: none;
            }
            
            .sidebar .brand {
                padding: 25px 15px;
                justify-content: center;
            }
            
            .sidebar .nav-links a {
                justify-content: center;
                padding: 18px 15px;
            }
            
            .sidebar .nav-links a i {
                margin-right: 0;
                font-size: 1.4rem;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .header {
                left: 80px;
            }
        }
        
        @media (max-width: 992px) {
            .card-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 33%;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
                flex-direction: column;
                height: auto;
                padding: 15px 0;
            }
            
            .header h2 {
                margin-bottom: 15px;
            }
            
            .main-content {
                padding: 20px 15px;
                padding-top: 110px;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                flex: 1;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, minmax(40px, 1fr));
                gap: 8px;
            }
            
            .calendar-day {
                min-height: 90px;
                padding: 10px;
            }
            
            .appointment-item {
                padding: 6px;
                font-size: 0.7rem;
            }
            
            .modal-content {
                width: 95%;
                padding: 25px;
            }
        }
        
        @media (max-width: 576px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                z-index: 2000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .header {
                left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1500;
                background: var(--dark-accent);
                color: white;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            }
        }
        
        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1500;
            background: linear-gradient(90deg, var(--dark-accent), #7c3aed);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .mobile-menu-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <div class="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"><i class="fas fa-spinner"></i></div>
        <div>Loading dashboard...</div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-dumbbell"></i>
            <h2>Fitness Repair</h2>
        </div>
        <div class="nav-links">
            <a href="#" data-view="dashboard" class="active">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" data-view="appointments">
                <i class="fas fa-calendar-check"></i>
                <span>Appointments</span>
            </a>
            <a href="#" data-view="calendar">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </a>
            <a href="#" data-view="customers">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </a>
            <a href="#" data-view="reports">
                <i class="fas fa-chart-pie"></i>
                <span>Reports</span>
            </a>
            <a href="#" data-view="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
            <a href="#" data-view="help">
                <i class="fas fa-question-circle"></i>
                <span>Help Center</span>
            </a>
            <a href="#" data-view="logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div>
                        <div id="user-name">admin@fitnessrepair.com</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="appointments">Appointments</div>
            <div class="tab" data-tab="calendar">Calendar</div>
            <div class="tab" data-tab="customers">Customers</div>
            <div class="tab" data-tab="reports">Reports</div>
            <div class="tab" data-tab="settings">Settings</div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="tab-content active">
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Total Appointments</div>
                        <div class="card-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                    </div>
                    <div class="card-content" id="total-appointments">0</div>
                    <div class="card-footer">
                        <i class="fas fa-arrow-up"></i> Loading...
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Scheduled</div>
                        <div class="card-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="card-content" id="scheduled-count">0</div>
                    <div class="card-footer">
                        <i class="fas fa-plus"></i> Loading...
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">In Progress</div>
                        <div class="card-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                    </div>
                    <div class="card-content" id="inprogress-count">0</div>
                    <div class="card-footer">
                        <i class="fas fa-exclamation-triangle"></i> Loading...
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Completed</div>
                        <div class="card-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="card-content" id="released-count">0</div>
                    <div class="card-footer">
                        <i class="fas fa-arrow-up"></i> Loading...
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Appointments Overview</div>
                    <div class="card-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                </div>
                <div style="height: 350px;">
                    <canvas id="appointmentsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Appointments View -->
        <div id="appointments-view" class="tab-content">
            <div style="margin-bottom: 25px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <button id="add-appointment" class="btn">
                    <i class="fas fa-plus"></i> Add Appointment
                </button>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <input type="text" id="search-appointments" class="form-control" placeholder="Search appointments..." style="min-width: 250px;">
                    <button class="btn" id="print-schedule"><i class="fas fa-print"></i> Print</button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Equipment</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading appointments...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; flex-wrap: wrap; gap: 15px;">
                <button id="prev-page" class="btn secondary" disabled>Previous</button>
                <div id="page-indicator">Page 1 of 1</div>
                <button id="next-page" class="btn" disabled>Next</button>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendar-view" class="tab-content">
            <div class="calendar-header">
                <h2 id="current-month-year">Loading...</h2>
                <div class="calendar-nav">
                    <button id="prev-month" class="btn secondary"><i class="fas fa-chevron-left"></i> Prev</button>
                    <button id="next-month" class="btn">Next <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Month Summary</div>
                        <div class="card-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div>
                            <div class="card-content" id="summary-total">0</div>
                            <div class="card-footer">Total Appointments</div>
                        </div>
                        <div>
                            <div class="card-content" id="summary-days">0</div>
                            <div class="card-footer">Business Days</div>
                        </div>
                        <div>
                            <div class="card-content" id="summary-revenue">$0</div>
                            <div class="card-footer">Revenue</div>
                        </div>
                        <div>
                            <div class="card-content" id="summary-utilization">0%</div>
                            <div class="card-footer">Utilization</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance Metrics</div>
                        <div class="card-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div>
                            <div class="card-content" id="current-appointments">0</div>
                            <div class="card-footer">Current</div>
                        </div>
                        <div>
                            <div class="card-content" id="monthly-released">0</div>
                            <div class="card-footer">Completed</div>
                        </div>
                        <div>
                            <div class="card-content" id="monthly-revenue">$0</div>
                            <div class="card-footer">Revenue</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendar-days">
                <!-- Calendar days will be populated dynamically -->
            </div>
        </div>

        <!-- Customers View -->
        <div id="customers-view" class="tab-content">
            <div style="margin-bottom: 25px;">
                <button id="add-customer" class="btn">
                    <i class="fas fa-user-plus"></i> Add Customer
                </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Favorite Equipment</th>
                            <th>Last Appointment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading customers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointment-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="appointment-modal-title"><i class="fas fa-calendar-plus"></i> Add New Appointment</h2>
            <form id="appointment-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label>Customer Name</label>
                        <input type="text" id="customer-name" class="form-control" placeholder="Enter customer name" required>
                        <div class="validation-error" id="customer-name-error"></div>
                      </div>
                    <div>
                        <label>Phone Number</label>
                        <input type="tel" id="customer-phone" class="form-control" placeholder="Enter phone number">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label>Date</label>
                        <input type="date" id="appointment-date" class="form-control" required>
                        <div class="validation-error" id="customer-name-error"></div>
                    </div>
                    <div>
                        <label>Time</label>
                        <input type="time" id="appointment-time" class="form-control" required>
                        <div class="validation-error" id="customer-name-error"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Equipment</label>
                    <input type="text" id="equipment" class="form-control" placeholder="Enter equipment type">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Price ($)</label>
                    <input type="number" id="appointment-price" class="form-control" value="150">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Issue Description</label>
                    <textarea id="issue-description" class="form-control" placeholder="Describe the issue"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Repair Notes</label>
                    <textarea id="repair-notes" class="form-control" placeholder="Add repair notes"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Status</label>
                    <select id="appointment-status" class="form-control">
                        <option value="scheduled">Scheduled</option>
                        <option value="draft">Draft</option>
                        <option value="in_progress">In Progress</option>
                        <option value="needs_parts">Needs Parts</option>
                        <option value="parts_ordered">Parts Ordered</option>
                        <option value="repair_completed">Repair Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="save-appointment" class="btn">Save Appointment</button>
                    <button type="button" id="cancel-appointment" class="btn secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="customer-modal-title"><i class="fas fa-user-plus"></i> Add New Customer</h2>
            <form id="customer-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label>Full Name</label>
                        <input type="text" id="customer-modal-name" class="form-control" placeholder="Enter full name" required>
                    </div>
                    <div>
                        <label>Phone Number</label>
                        <input type="tel" id="customer-modal-phone" class="form-control" placeholder="Enter phone number" required>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Email Address</label>
                    <input type="email" id="customer-modal-email" class="form-control" placeholder="Enter email address">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Address</label>
                    <input type="text" id="customer-modal-address" class="form-control" placeholder="Enter address">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Notes</label>
                    <textarea id="customer-modal-notes" class="form-control" placeholder="Add customer notes"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="save-customer" class="btn">Save Customer</button>
                    <button type="button" id="cancel-customer" class="btn secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        console.log("✅ Admin dashboard initialized");
        
        // ================ FIREBASE INITIALIZATION ================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            Timestamp,
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        async function getFirebaseConfig() {
            try {
                const response = await fetch(
                    "https://cfr-backend-1.onrender.com/api/firebase-config"
                );
                return await response.json();
            } catch (error) {
                console.error("Error fetching Firebase config:", error);
                showToast("Failed to initialize Firebase", true);
                return null;
            }
        }

        (async () => {
            const firebaseConfig = await getFirebaseConfig();
            if (!firebaseConfig) {
                showToast("App configuration failed to load.", true);
                return;
            }

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const appointmentsCollection = collection(db, "appointments");
            const customersCollection = collection(db, "customers");

            // Start your app logic
            initApp(auth, db, appointmentsCollection, customersCollection);
        })();
        // ===== CACHING MECHANISM =====
let cachedAppointments = null;
let lastFetchTime = 0;
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

async function fetchAppointmentsWithCache() {
  const now = Date.now();
  if (cachedAppointments && now - lastFetchTime < CACHE_DURATION) {
    return cachedAppointments;
  }
  
  showLoading(true);
  try {
    const snapshot = await getDocs(appointmentsCollection);
    cachedAppointments = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        ...data,
        dateObj: data.date ? data.date.toDate() : new Date()
      };
    });
    lastFetchTime = now;
    return cachedAppointments;
  } catch (error) {
    console.error("Error fetching appointments:", error);
    showToast("Failed to fetch appointments", true);
    return [];
  } finally {
    showLoading(false);
  }
}

// ===== ERROR HANDLING FOR FIREBASE =====
async function initializeFirebaseWithRetry(retries = 3, delay = 2000) {
  try {
    const firebaseConfig = await getFirebaseConfig();
    if (!firebaseConfig) throw new Error("Invalid Firebase config");
    
    const app = initializeApp(firebaseConfig);
    return {
      db: getFirestore(app),
      auth: getAuth(app),
      appointmentsCollection: collection(getFirestore(app), "appointments"),
      customersCollection: collection(getFirestore(app), "customers")
    };
  } catch (error) {
    if (retries > 0) {
      console.log(`Retrying Firebase initialization... (${retries} left)`);
      await new Promise(resolve => setTimeout(resolve, delay));
      return initializeFirebaseWithRetry(retries - 1, delay * 2);
    }
    throw error;
  }
}

// ===== PAGINATION FOR CUSTOMERS =====
let currentCustomerPage = 1;
const customersPerPage = 10;

async function fetchCustomers() {
  showLoading(true);
  try {
    const snapshot = await getDocs(customersCollection);
    customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderCustomersTable();
  } catch (error) {
    console.error("Error fetching customers:", error);
    showToast("Failed to load customers", true);
  } finally {
    showLoading(false);
  }
}

function renderCustomersTable() {
  const tbody = document.getElementById('customers-body');
  tbody.innerHTML = '';
  
  if (customers.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="no-data">No customers found</td></tr>`;
    return;
  }
  
  const start = (currentCustomerPage - 1) * customersPerPage;
  const pageCustomers = customers.slice(start, start + customersPerPage);
  
  pageCustomers.forEach(customer => {
    // ... existing customer row code
  });
  
  // Add pagination controls for customers
  const totalPages = Math.ceil(customers.length / customersPerPage);
  document.getElementById("customer-page-indicator").textContent = 
    `Page ${currentCustomerPage} of ${totalPages}`;
  
  document.getElementById("customer-prev-page").disabled = currentCustomerPage === 1;
  document.getElementById("customer-next-page").disabled = currentCustomerPage >= totalPages;
}

// ===== SEARCH FUNCTIONALITY FOR APPOINTMENTS =====
function setupAdvancedSearch() {
  const searchInput = document.getElementById('search-appointments');
  searchInput.addEventListener('input', function() {
    const term = this.value.toLowerCase();
    
    if (!term) {
      renderAppointmentsTable(appointments);
      return;
    }
    
    const filtered = appointments.filter(app => 
      app.customer.toLowerCase().includes(term) ||
      (app.phone && app.phone.toLowerCase().includes(term)) ||
      (app.equipment && app.equipment.toLowerCase().includes(term)) ||
      (app.status && statusMap[app.status]?.text.toLowerCase().includes(term))
    );
    
    renderAppointmentsTable(filtered);
  });
}

// ===== LOADING SKELETONS =====
function showSkeletonLoader(containerId, rows = 5) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  for (let i = 0; i < rows; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton-row';
    skeleton.innerHTML = `
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
      <div class="skeleton-cell"></div>
    `;
    container.appendChild(skeleton);
  }
}

        // ================ UTILITY FUNCTIONS ================
        function showLoading(show = true) {
            const loadingElement = document.getElementById('loading-overlay');
            if (loadingElement) {
                loadingElement.style.display = show ? 'flex' : 'none';
            }
        }
        
        function showToast(message, isError = false) {
            const toast = document.createElement("div");
            toast.className = `toast ${isError ? "error" : "success"}`;
            toast.innerHTML = `
                <i class="fas ${isError ? "fa-exclamation-circle" : "fa-check-circle"}"></i>
                <div>${message}</div>
            `;
            document.getElementById("toast-container").appendChild(toast);
            
            setTimeout(() => toast.classList.add("show"), 100);
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function formatTimestamp(dateObj) {
            if (!dateObj) return "N/A";
            
            try {
                return dateObj.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            } catch (e) {
                return "Invalid Date";
            }
        }
        
        function getBusinessDays(month, year) {
            let count = 0;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(year, month, day);
                if (d.getDay() !== 0 && d.getDay() !== 6) count++;
            }
            return count;
        }
        
        // ================ MAIN APPLICATION ================
        function initApp(auth, db, appointmentsCollection, customersCollection) {
            // ================ GLOBAL STATE ================
            let appointments = [];
            let customers = [];
            let editingAppointmentId = null;
            let editingCustomerId = null;
            let chartInstance = null;
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let currentPage = 1;
            const appointmentsPerPage = 10;
            
            // Status map for appointments
            const statusMap = {
                scheduled: { text: "Scheduled", class: "status-scheduled" },
                draft: { text: "Draft", class: "status-draft" },
                released: { text: "Released", class: "status-released" },
                in_progress: { text: "In Progress", class: "status-inprogress" },
                cancelled: { text: "Cancelled", class: "status-cancelled" },
                needs_parts: { text: "Needs Parts", class: "status-warning" },
                parts_ordered: { text: "Parts Ordered", class: "status-inprogress" },
                repair_completed: { text: "Completed", class: "status-released" }
            };
            // ================ VALIDATION UTILITIES ================
const validators = {
    required: value => value.trim() !== '',
    validDate: value => new Date(value).toString() !== 'Invalid Date',
    validTime: value => /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value),
    validPrice: value => !isNaN(parseFloat(value)) && parseFloat(value) >= 0
};

function showValidationError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorId = `${fieldId}-error`;
    const errorElement = document.getElementById(errorId);
    
    if (!field || !errorElement) return;
    
    field.classList.add('invalid');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function clearValidationError(fieldId) {
    const field = document.getElementById(fieldId);
    const errorId = `${fieldId}-error`;
    const errorElement = document.getElementById(errorId);
    
    if (field) field.classList.remove('invalid');
    if (errorElement) errorElement.style.display = 'none';
}

function setupFieldValidation(fieldId, validator, errorMessage) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    field.addEventListener('blur', () => {
        if (!validator(field.value)) {
            showValidationError(fieldId, errorMessage);
        }
    });
    
    field.addEventListener('input', () => {
        if (validator(field.value)) {
            clearValidationError(fieldId);
        }
    });
}

function initializeValidation() {
    // Customer fields
    setupFieldValidation('customer-name', validators.required, 'Customer name is required');
    setupFieldValidation('appointment-date', validators.validDate, 'Please select a valid date');
    setupFieldValidation('appointment-time', validators.validTime, 'Please select a valid time');
    setupFieldValidation('appointment-price', validators.validPrice, 'Please enter a valid price');
}
            // ================ VIEW MANAGEMENT ================
            function activateView(viewName) {
                // Update sidebar active state
                document.querySelectorAll('.nav-links a').forEach(link => {
                    link.classList.toggle('active', link.dataset.view === viewName);
                });
                
                // Hide all views
                document.querySelectorAll('.tab-content').forEach(view => {
                    view.classList.remove('active');
                });
                
                // Show requested view
                const viewElement = document.getElementById(`${viewName}-view`);
                if (viewElement) viewElement.classList.add('active');
                
                // Initialize view-specific content
                switch(viewName) {
                    case "dashboard":
                        updateStats();
                        initChart();
                        break;
                    case "appointments":
                        fetchAppointments();
                        break;
                    case "calendar":
                        renderCalendar();
                        updateCalendarSummary();
                        break;
                    case "customers":
                        fetchCustomers();
                        break;
                    case "reports":
                        // generateReports();
                        break;
                    case "settings":
                        // loadSettings();
                        break;
                }
            }
            
            // ================ AUTHENTICATION HANDLING ================
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    window.location.href = "admin-login.html";
                } else {
                    // Show logged-in user's email
                    document.getElementById("user-name").textContent = user.email;
                    fetchAppointments();
                }
            });
            
            // Logout function
            function logout() {
                if (confirm("Are you sure you want to logout?")) {
                    signOut(auth)
                        .then(() => {
                            window.location.href = "admin-login.html";
                        })
                        .catch((error) => {
                            console.error("Logout error:", error);
                            showToast("Logout failed", true);
                        });
                }
            }
            
            // ================ DATA MANAGEMENT ================
            // Fetch appointments from Firestore
            async function fetchAppointments() {
                showLoading(true);
                try {
                    const snapshot = await getDocs(appointmentsCollection);
                    appointments = snapshot.docs.map((doc) => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            dateObj: data.date ? data.date.toDate() : new Date()
                        };
                    });
                    renderAppointmentsTable();
                    updateStats();
                    renderCalendar();
                    updateCalendarSummary();
                    initChart();
                } catch (error) {
                    console.error("Error fetching appointments:", error);
                    showToast("Failed to fetch appointments", true);
                } finally {
                    showLoading(false);
                }
            }
            
            // Fetch customers from Firestore
            async function fetchCustomers() {
                showLoading(true);
                try {
                    const snapshot = await getDocs(customersCollection);
                    customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCustomersTable();
                } catch (error) {
                    console.error("Error fetching customers:", error);
                    showToast("Failed to load customers", true);
                } finally {
                    showLoading(false);
                }
            }
            
            // Save (add or update) appointment in Firestore
            async function saveAppointment(data) {
              if (!data.customer) {
        showToast("Customer name is required", true);
        return;
    }
    
    if (!data.date || data.date.toDate().toString() === 'Invalid Date') {
        showToast("Invalid date selected", true);
        return;
    }
                showLoading(true);
                try {
                    if (editingAppointmentId) {
                        const docRef = doc(db, "appointments", editingAppointmentId);
                        await updateDoc(docRef, data);
                        showToast("Appointment updated successfully");
                    } else {
                        await addDoc(appointmentsCollection, data);
                        showToast("Appointment added successfully");
                    }
                    editingAppointmentId = null;
                    await fetchAppointments();
                    document.getElementById('appointment-modal').classList.remove('active');
                } catch (error) {
                    console.error("Error saving appointment:", error);
                    showToast("Failed to save appointment", true);
                } finally {
                    showLoading(false);
                }
            }
            
            // Delete appointment from Firestore
            async function deleteAppointment(id) {
                if (!confirm("Are you sure you want to delete this appointment?")) return;
                
                showLoading(true);
                try {
                    await deleteDoc(doc(db, "appointments", id));
                    showToast("Appointment deleted successfully");
                    await fetchAppointments();
                } catch (error) {
                    console.error("Error deleting appointment:", error);
                    showToast("Failed to delete appointment", true);
                } finally {
                    showLoading(false);
                }
            }
            
            // Save customer to Firestore
            async function saveCustomer() {
                showLoading(true);
                const customerData = {
                    name: document.getElementById('customer-modal-name').value.trim(),
                    phone: document.getElementById('customer-modal-phone').value.trim(),
                    email: document.getElementById('customer-modal-email').value.trim(),
                    address: document.getElementById('customer-modal-address').value.trim(),
                    notes: document.getElementById('customer-modal-notes').value.trim(),
                    createdAt: new Date().toISOString()
                };
                
                try {
                    if (editingCustomerId) {
                        await updateDoc(doc(db, "customers", editingCustomerId), customerData);
                        showToast("Customer updated!");
                    } else {
                        await addDoc(customersCollection, customerData);
                        showToast("Customer added!");
                    }
                    document.getElementById('customer-modal').classList.remove('active');
                    fetchCustomers();
                } catch (error) {
                    showToast("Failed to save customer", true);
                } finally {
                    showLoading(false);
                }
            }
            
            // ================ RENDERING FUNCTIONS ================
            // Render appointments table
            function renderAppointmentsTable(list = appointments) {
                const tbody = document.getElementById("appointments-body");
                tbody.innerHTML = "";
                
                if (list.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                No appointments found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const start = (currentPage - 1) * appointmentsPerPage;
                const pageApps = list.slice(start, start + appointmentsPerPage);
                
                pageApps.forEach((app) => {
                    const statusInfo = statusMap[app.status] || {
                        text: app.status || "",
                        class: "",
                    };
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>#${app.id}</td>
                        <td>${app.customer}</td>
                        <td>${app.equipment || ""}</td>
                        <td>${formatTimestamp(app.dateObj)}</td>
                        <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                        <td>$${app.price || 0}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${app.id}" aria-label="Edit appointment"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-btn" data-id="${app.id}" aria-label="Delete appointment"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Add click listeners to buttons
                tbody.querySelectorAll(".edit-btn").forEach((btn) => {
                    btn.onclick = () => openEditModal(btn.dataset.id);
                });
                
                tbody.querySelectorAll(".delete-btn").forEach((btn) => {
                    btn.onclick = () => deleteAppointment(btn.dataset.id);
                });
                
                // Update page indicator
                const totalPages = Math.ceil(list.length / appointmentsPerPage);
                document.getElementById("page-indicator").textContent = `Page ${currentPage} of ${totalPages || 1}`;
                
                // Enable/disable pagination buttons
                document.getElementById("prev-page").disabled = currentPage === 1;
                document.getElementById("next-page").disabled = currentPage >= totalPages;
            }
            
            // Render customers table
            function renderCustomersTable() {
                const tbody = document.getElementById('customers-body');
                tbody.innerHTML = '';
                
                if (customers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px;">
                                No customers found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.favoriteEquipment || '-'}</td>
                        <td>${customer.lastAppointment || 'Never'}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${customer.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${customer.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Attach event listeners to each edit/delete button
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => openEditCustomerModal(btn.dataset.id));
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (confirm("Are you sure you want to delete this customer?")) {
                            deleteCustomer(btn.dataset.id);
                        }
                    });
                });
            }
            
            // Delete customer
            async function deleteCustomer(id) {
                showLoading(true);
                try {
                    await deleteDoc(doc(db, "customers", id));
                    showToast("Customer deleted successfully");
                    fetchCustomers();
                } catch (error) {
                    showToast("Failed to delete customer", true);
                    console.error(error);
                } finally {
                    showLoading(false);
                }
            }
            
            // Stats update
            function updateStats() {
                document.getElementById("total-appointments").textContent = appointments.length;
                document.getElementById("scheduled-count").textContent = appointments.filter((a) => a.status === "scheduled").length;
                document.getElementById("inprogress-count").textContent = appointments.filter((a) => a.status === "in_progress").length;
                document.getElementById("released-count").textContent = appointments.filter((a) => a.status === "released").length;
            }
            
            // Calendar rendering and summary
            function renderCalendar() {
                const calendarGrid = document.getElementById("calendar-days");
                calendarGrid.innerHTML = "";
                
                const monthNames = ["January", "February", "March", "April", "May", "June",
                  "July", "August", "September", "October", "November", "December"];
                
                document.getElementById("current-month-year").textContent = 
                    `${monthNames[currentMonth]} ${currentYear}`;
                
                const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                daysOfWeek.forEach((day) => {
                    const dayHeader = document.createElement("div");
                    dayHeader.className = "calendar-day-header";
                    dayHeader.textContent = day;
                    calendarGrid.appendChild(dayHeader);
                });
                
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement("div");
                    emptyCell.className = "calendar-day empty";
                    calendarGrid.appendChild(emptyCell);
                }
                
                for (let day = 1; day <= totalDays; day++) {
                    const dayCell = document.createElement("div");
                    dayCell.className = "calendar-day";
                    
                    const dayNumber = document.createElement("div");
                    dayNumber.className = "day-number";
                    dayNumber.textContent = day;
                    dayCell.appendChild(dayNumber);
                    
                    // Get appointments for this day
                    const dayApps = appointments.filter(app => {
                        if (!app.dateObj) return false;
                        const d = app.dateObj;
                        return d.getDate() === day && 
                               d.getMonth() === currentMonth && 
                               d.getFullYear() === currentYear;
                    });
                    
                    if (dayApps.length > 0) {
                        const container = document.createElement("div");
                        container.className = "calendar-appointments";
                        
                        dayApps.forEach(app => {
                            const item = document.createElement("div");
                            item.className = "appointment-item";
                            const time = app.dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            item.textContent = `${app.customer.split(" ")[0]} - ${time}`;
                            container.appendChild(item);
                        });
                        
                        dayCell.appendChild(container);
                    }
                    
                    calendarGrid.appendChild(dayCell);
                }
            }
            
            function updateCalendarSummary() {
                const monthlyApps = appointments.filter((app) => {
                    if (!app.dateObj) return false;
                    const d = app.dateObj;
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                
                const businessDays = getBusinessDays(currentMonth, currentYear);
                const monthlyRevenue = monthlyApps
                    .filter((a) => a.status === "released")
                    .reduce((sum, a) => sum + (a.price || 0), 0);
                
                document.getElementById("summary-total").textContent = monthlyApps.length;
                document.getElementById("summary-days").textContent = businessDays;
                document.getElementById("summary-revenue").textContent = `$${monthlyRevenue}`;
                
                const utilizationRate = Math.min(100, Math.round((monthlyApps.length / (businessDays * 3)) * 100));
                document.getElementById("summary-utilization").textContent = utilizationRate + "%";
            }
            
            // Chart.js setup
            function initChart() {
                const ctx = document.getElementById("appointmentsChart").getContext("2d");
                
                // Destroy existing chart if it exists
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                const counts = {
                    draft: appointments.filter((a) => a.status === "draft").length,
                    scheduled: appointments.filter((a) => a.status === "scheduled").length,
                    in_progress: appointments.filter((a) => a.status === "in_progress").length,
                    released: appointments.filter((a) => a.status === "released").length,
                    cancelled: appointments.filter((a) => a.status === "cancelled").length,
                };
                
                chartInstance = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Draft", "Scheduled", "In Progress", "Completed", "Cancelled"],
                        datasets: [{
                            data: Object.values(counts),
                            backgroundColor: [
                                "rgba(149, 165, 166, 0.7)",
                                "rgba(93, 93, 255, 0.7)",
                                "rgba(52, 152, 219, 0.7)",
                                "rgba(46, 204, 113, 0.7)",
                                "rgba(231, 76, 60, 0.7)",
                            ],
                            borderColor: [
                                "rgba(149, 165, 166, 1)",
                                "rgba(93, 93, 255, 1)",
                                "rgba(52, 152, 219, 1)",
                                "rgba(46, 204, 113, 1)",
                                "rgba(231, 76, 60, 1)",
                            ],
                            borderWidth: 1,
                        }],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "right",
                                labels: { color: "#e5e7eb", font: { size: 12 } },
                            },
                            title: {
                                display: true,
                                text: "Appointment Status Distribution",
                                color: "#e5e7eb",
                                font: { size: 16 },
                            },
                        },
                    },
                });
            }
            
            // ================ MODAL MANAGEMENT ================
            function openEditModal(id) {
                const app = appointments.find((a) => a.id === id);
                if (!app) return;
                
                editingAppointmentId = id;
                    // Clear validation errors
    document.querySelectorAll('.validation-error').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.form-control').forEach(field => {
        field.classList.remove('invalid');
    });
                document.getElementById("customer-name").value = app.customer;
                document.getElementById("customer-phone").value = app.phone || "";
                
                // Use the dateObj for editing
                const dateObj = app.dateObj || new Date();
                document.getElementById("appointment-date").value = dateObj.toISOString().split("T")[0];
                
                // Format time as HH:MM
                const hours = dateObj.getHours().toString().padStart(2, '0');
                const minutes = dateObj.getMinutes().toString().padStart(2, '0');
                document.getElementById("appointment-time").value = `${hours}:${minutes}`;
                
                document.getElementById("equipment").value = app.equipment || "";
                document.getElementById("appointment-price").value = app.price || 150;
                document.getElementById("issue-description").value = app.issue || "";
                document.getElementById("repair-notes").value = app.repair_notes || "";
                document.getElementById("appointment-status").value = app.status || "";
                
                document.getElementById("modal-title").textContent = "Edit Appointment";
                document.getElementById("save-appointment").textContent = "Update Appointment";
                
                document.getElementById('appointment-modal').classList.add('active');
            }
            
            function openAddModal() {
              // Clear validation states
    const fields = document.querySelectorAll('#appointment-form .form-control');
    fields.forEach(field => {
        field.classList.remove('invalid');
        const errorId = `${field.id}-error`;
        const errorElement = document.getElementById(errorId);
        if (errorElement) errorElement.textContent = '';
    });
    editingAppointmentId = null;
    
    // Reset form and set default values
    document.getElementById("appointment-form").reset();

        // Clear validation errors
        document.querySelectorAll('.validation-error').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.form-control').forEach(field => {
        field.classList.remove('invalid');
    });
    
    const today = new Date();
    document.getElementById("appointment-date").value = today.toISOString().split("T")[0];
    
    const nextHour = new Date(today.getTime() + 60 * 60 * 1000);
    document.getElementById("appointment-time").value = 
        `${nextHour.getHours().toString().padStart(2, "0")}:${nextHour.getMinutes().toString().padStart(2, "0")}`;
    
    document.getElementById("appointment-price").value = 150;
    
    // Update modal title
    document.getElementById("appointment-modal-title").innerHTML = 
        '<i class="fas fa-calendar-plus"></i> Add New Appointment';
    
    // Show modal
    document.getElementById('appointment-modal').classList.add('active');
}        
            
function closeAppointmentModal() {
                document.getElementById('appointment-modal').classList.remove('active');
            }
            
            function openAddCustomerModal() {
    editingCustomerId = null;
    document.getElementById('customer-form').reset();
    
    // Update modal title
    document.getElementById("customer-modal-title").innerHTML = 
        '<i class="fas fa-user-plus"></i> Add New Customer';
    
    // Show modal
    document.getElementById('customer-modal').classList.add('active');
}  
            function openEditCustomerModal(id) {
                const customer = customers.find(c => c.id === id);
                if (!customer) return;
                
                editingCustomerId = id;
                document.getElementById('customer-modal-name').value = customer.name || '';
                document.getElementById('customer-modal-phone').value = customer.phone || '';
                document.getElementById('customer-modal-email').value = customer.email || '';
                document.getElementById('customer-modal-address').value = customer.address || '';
                document.getElementById('customer-modal-notes').value = customer.notes || '';
                
                document.getElementById('customer-modal-title').textContent = "Edit Customer";
                document.getElementById('customer-modal').classList.add('active');
            }
            
            function closeCustomerModal() {
                document.getElementById('customer-modal').classList.remove('active');
            }
            
            // ================ EVENT LISTENERS ================
            function setupEventListeners() {
                // Sidebar navigation
                document.querySelectorAll(".nav-links a").forEach(link => {
                    link.addEventListener("click", (e) => {
                        e.preventDefault();
                        const view = link.dataset.view;
                        activateView(view);
                    });
                });
                
                // Logout button
                document.querySelector('.nav-links a[data-view="logout"]').addEventListener("click", (e) => {
                    e.preventDefault();
                    logout();
                });
                
                // Top tab navigation
                document.querySelectorAll(".tab").forEach(tab => {
                    tab.addEventListener("click", () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        activateView(tab.dataset.tab);
                    });
                });
                
                // Month navigation buttons
                document.getElementById("prev-month").addEventListener("click", () => {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    renderCalendar();
                    updateCalendarSummary();
                });
                
                document.getElementById("next-month").addEventListener("click", () => {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    renderCalendar();
                    updateCalendarSummary();
                });
                
                // Appointment pagination
                document.getElementById("prev-page").addEventListener("click", () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderAppointmentsTable();
                    }
                });
                
                document.getElementById("next-page").addEventListener("click", () => {
                    const totalPages = Math.ceil(appointments.length / appointmentsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderAppointmentsTable();
                    }
                });
                
                // Search functionality
                document.getElementById("search-appointments").addEventListener("input", function () {
                    const keyword = this.value.toLowerCase();
                    const filtered = appointments.filter(
                        (app) => app.customer.toLowerCase().includes(keyword) ||
                                 (app.phone && app.phone.toLowerCase().includes(keyword))
                    );
                    currentPage = 1;
                    renderAppointmentsTable(filtered);
                });
                
                // Print button
                document.getElementById("print-schedule").addEventListener("click", () => {
                    window.print();
                });
                
                // Add appointment button
                document.getElementById("add-appointment").addEventListener("click", openAddModal);
                
                document.getElementById("save-appointment").addEventListener("click", async () => {
    // Clear previous errors
    document.querySelectorAll('.validation-error').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.form-control').forEach(field => {
        field.classList.remove('invalid');
    });

    // Validation helper functions
    const validators = {
        required: value => value.trim() !== '',
        validDate: value => !isNaN(Date.parse(value)),
        validTime: value => /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value.trim()),
        validPrice: value => !isNaN(parseFloat(value)) && parseFloat(value) >= 0
    };

    let isValid = true;
    let firstInvalidField = null;

    const fieldsToValidate = [
        { id: 'customer-name', validator: validators.required, message: 'Customer name is required' },
        { id: 'appointment-date', validator: validators.validDate, message: 'Please select a valid date' },
        { id: 'appointment-time', validator: validators.validTime, message: 'Please select a valid time' },
        { id: 'appointment-price', validator: validators.validPrice, message: 'Please enter a valid price' }
    ];

    fieldsToValidate.forEach(({ id, validator, message }) => {
        const field = document.getElementById(id);
        if (field && !validator(field.value)) {
            showValidationError(id, message);
            field.classList.add('invalid');
            if (!firstInvalidField) {
                firstInvalidField = field;
            }
            isValid = false;
        }
    });

    if (!isValid) {
        if (firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        showToast("Please fix validation errors", true);
        return;
    }

    // Proceed with save if valid...
    try {
        if (!auth.currentUser) {
            showToast("You need to re-authenticate. Redirecting to login...", true);
            setTimeout(() => window.location.href = "admin-login.html", 2000);
            return;
        }

        const customerName = document.getElementById("customer-name").value.trim();
        const phone = document.getElementById("customer-phone").value.trim();
        const dateInput = document.getElementById("appointment-date").value;
        const timeInput = document.getElementById("appointment-time").value;
        const dateObj = new Date(`${dateInput}T${timeInput}`);
        const timestamp = Timestamp.fromDate(dateObj);
        const equipment = document.getElementById("equipment").value.trim();
        const price = parseFloat(document.getElementById("appointment-price").value) || 0;
        const issue = document.getElementById("issue-description").value.trim();
        const status = document.getElementById("appointment-status").value;
        const repairNotes = document.getElementById("repair-notes").value.trim();

        const appointmentData = {
            customer: customerName,
            phone,
            equipment,
            date: timestamp,
            price,
            issue,
            status,
            repair_notes: repairNotes,
        };

        showToast("Saving appointment...");

        const appointmentId = document.getElementById("appointment-id")?.value;

        if (appointmentId) {
            await db.collection("appointments").doc(appointmentId).update(appointmentData);
            showToast("Appointment updated successfully!");
        } else {
            await db.collection("appointments").add(appointmentData);
            showToast("Appointment saved successfully!");
            document.getElementById("appointment-form").reset();
        }

    } catch (error) {
        console.error("Error saving appointment:", error);
        showToast(`Error saving appointment: ${error.message}`, true);
    }
});
           
                // Modal controls
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        closeAppointmentModal();
                        closeCustomerModal();
                    });
                });
                
                document.getElementById("cancel-appointment").addEventListener("click", closeAppointmentModal);
                
                // Customer modals
                document.getElementById('add-customer').addEventListener('click', openAddCustomerModal);
                document.getElementById('save-customer').addEventListener('click', saveCustomer);
                document.getElementById('cancel-customer').addEventListener('click', closeCustomerModal);
                
                // Mobile menu toggle
                const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
                const sidebar = document.querySelector('.sidebar');
                
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
            
            // ================ INITIALIZATION ================
            function initialize() {
    setupEventListeners();
    activateView('dashboard');
    
    // Set current date for appointment form
    const today = new Date();
    document.getElementById("appointment-date").value = today.toISOString().split("T")[0];
    
    const nextHour = new Date(today.getTime() + 60 * 60 * 1000);
    document.getElementById("appointment-time").value = 
        `${nextHour.getHours().toString().padStart(2, "0")}:${nextHour.getMinutes().toString().padStart(2, "0")}`;
    
    // Initialize form validation
    initializeValidation();
    
    // Hide loading overlay after 1.5s
    setTimeout(() => {
        document.getElementById('loading-overlay').style.display = 'none';
    }, 1500);
}
            
            // Start the application
            initialize();
        }
    </script>
</body>
</html>