<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Canadian Fitness Repair</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="stylesheet" href="https://cdn.gomaps.pro/gomaps.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --dark-bg: #121826;
            --dark-card: #1f2937;
            --dark-border: #374151;
            --dark-text: #e5e7eb;
            --dark-accent: #3b82f6;
            --dark-hover: #4b5563;
            --dark-success: #10b981;
            --dark-warning: #f59e0b;
            --dark-danger: #ef4444;
            --dark-gray: #9ca3af;
            --dark-highlight: #1e40af;
            --dark-shadow: rgba(0, 0, 0, 0.4);
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        .action-btn.directions-btn {
    background: rgba(76, 175, 80, 0.1);
    color: #4CAF50;
}

.action-btn.directions-btn:hover {
    background: rgba(76, 175, 80, 0.2);
}
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark-card);
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 100;
            border-right: 1px solid var(--dark-border);
            box-shadow: 0 0 20px var(--dark-shadow);
        }
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 0 0 8px 8px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--dark-border);
        }
        
        .suggestion-item:hover {
            background: var(--dark-hover);
        }
        
      
        .brand {
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .brand h2 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .brand i {
            font-size: 1.8rem;
            color: var(--dark-accent);
        }
        
        .nav-links {
            padding: 20px 0;
        }
        
        .nav-links a {
            display: flex;
            align-items: center;
            padding: 16px 30px;
            color: var(--dark-gray);
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
            font-weight: 500;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--dark-accent);
            border-left: 4px solid var(--dark-accent);
        }
        
        .nav-links a i {
            margin-right: 15px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            transition: var(--transition);
        }
        
        .nav-links a.active i, .nav-links a:hover i {
            transform: scale(1.1);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 25px;
            padding-top: 90px;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px var(--dark-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 90;
            border-bottom: 1px solid var(--dark-border);
        }
        
        .header h2 {
            font-weight: 600;
            font-size: 1.4rem;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--dark-accent), #7c3aed);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .tabs {
            display: flex;
            background: var(--dark-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--dark-shadow);
            margin-bottom: 30px;
            border: 1px solid var(--dark-border);
        }
        
        .tab {
            padding: 16px 25px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            text-align: center;
            flex: 1;
            color: var(--dark-gray);
            position: relative;
            overflow: hidden;
        }
        
        .tab.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            color: var(--dark-accent);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            background: var(--dark-card);
            border-radius: 16px;
            box-shadow: 0 8px 30px var(--dark-shadow);
            margin-bottom: 35px;
            border: 1px solid var(--dark-border);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        .skeleton {
    height: 20px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    border-radius: 4px;
    animation: loading 1.5s infinite;
    margin: 8px 0;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.7), rgba(17, 24, 39, 0.7));
            border-radius: 16px;
            padding: 25px;
            transition: var(--transition);
            border: 1px solid var(--dark-border);
            box-shadow: 0 8px 20px var(--dark-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--dark-accent), #8b5cf6);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-text);
        }
          .error-message {
        color: red;
        font-size: 12px;
    }

    .spinner {
        font-size: 20px;
        color: #007bff;
    }
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(59, 130, 246, 0.15);
            color: var(--dark-accent);
        }
        
        .card-content {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-text);
            margin: 10px 0;
        }
        
        .card-footer {
            font-size: 0.9rem;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-footer i {
            color: var(--dark-success);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 15px var(--dark-shadow);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid var(--dark-border);
        }
        
        th {
            background-color: rgba(31, 41, 55, 0.8);
            font-weight: 600;
            color: var(--dark-accent);
            position: sticky;
            top: 0;
        }
        
        tr {
            transition: var(--transition);
        }
        
        tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .action-btn {
            background: rgba(59, 130, 246, 0.1);
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: var(--transition);
            color: var(--dark-accent);
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }
        
        .action-btn.delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--dark-danger);
        }
        
        .action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 13px;
  display: inline-block;
}

.status-scheduled { background: #e0f7fa; color: #006064; }
.status-inprogress { background: #fff3e0; color: #e65100; }
.status-awaiting { background: #f3e5f5; color: #6a1b9a; }
.status-arrived { background: #e8f5e9; color: #2e7d32; }
.status-install { background: #fbe9e7; color: #bf360c; }
.status-repaired { background: #ede7f6; color: #4527a0; }
.status-complete { background: #f1f8e9; color: #33691e; }
.status-cancelled { background: #ffebee; color: #c62828; }

        
        .status-scheduled {
            background: rgba(93, 93, 255, 0.15);
            color: #5d5dff;
        }
        
        .status-draft {
            background: rgba(149, 165, 166, 0.15);
            color: #95a5a6;
        }
        
        .status-released {
            background: rgba(46, 204, 113, 0.15);
            color: #2ecc71;
        }
        
        .status-inprogress {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }
        
        .status-cancelled {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }
        
        .status-warning {
            background: rgba(243, 156, 18, 0.15);
            color: #f39c12;
        }
        
        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 12px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 15px 10px;
            font-weight: 600;
            background: var(--dark-card);
            border-radius: 12px;
            color: var(--dark-accent);
            border: 1px solid var(--dark-border);
        }
        
        .calendar-day {
            min-height: 120px;
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.7), rgba(17, 24, 39, 0.7));
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 10px var(--dark-shadow);
            transition: var(--transition);
        }
        
        .calendar-day:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }
        
        .calendar-day.empty {
            background: transparent;
            box-shadow: none;
            border: none;
        }
        
        .day-number {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark-text);
            font-size: 1.1rem;
        }
        
        .appointment-item {
            background: rgba(59, 130, 246, 0.15);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--dark-accent);
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid var(--dark-accent);
        }
        
        .appointment-item:hover {
            background: rgba(59, 130, 246, 0.25);
        }
        #house-address-input.invalid {
  border-color: var(--dark-danger);
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}
        .btn {
            padding: 12px 22px;
            background: linear-gradient(90deg, var(--dark-accent), #7c3aed);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        /* Loading state for save operations */
.btn.loading {
    position: relative;
    color: transparent;
}
.btn.loading::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
}
        .btn.secondary {
            background: var(--dark-card);
            color: var(--dark-gray);
            box-shadow: 0 4px 15px var(--dark-shadow);
        }
        
        .btn.secondary:hover {
            background: var(--dark-hover);
            color: var(--dark-text);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Toast notifications */
        .toast {
    position: fixed;
    top: 25px;
    right: 25px;
    padding: 18px 28px;
    border-radius: 12px;
    background: var(--dark-card);
    color: white;
    z-index: 4000;
    box-shadow: 0 8px 25px var(--dark-shadow);
    opacity: 0;
    transform: translateY(-30px);
    transition: var(--transition);
    border: 1px solid var(--dark-border);
    display: flex;
    align-items: center;
    gap: 15px;
    max-width: 350px;
    /* Remove blur effect */
    backdrop-filter: none !important;
}
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
/* Make toasts more prominent */
.toast.error {
    background: rgba(239, 68, 68, 0.9);
    border-left: 4px solid #b91c1c;
}
        
.toast.success {
    background: rgba(16, 185, 129, 0.9);
    border-left: 4px solid #047857;
}

        
        .toast i {
            font-size: 1.4rem;
        }
        
        .toast.success i {
            color: var(--dark-success);
        }
        
        .toast.error i {
            color: var(--dark-danger);
        }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(18, 24, 38, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            flex-direction: column;
            display: none;
        }
        
        #loading-overlay .spinner {
            font-size: 3.5rem;
            margin-bottom: 25px;
            animation: spin 1.2s linear infinite;
            color: var(--dark-accent);
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--dark-card);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px var(--dark-shadow);
            border: 1px solid var(--dark-border);
            position: relative;
            padding: 35px;
            animation: modalIn 0.4s ease;
        }
.skeleton-row {
  display: flex;
  gap: 10px;
  padding: 12px;
  animation: pulse 1.5s infinite;
}
/* Add to your existing CSS */
.card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
}
.skeleton-cell {
  height: 20px;
  background: #2d3748;
  border-radius: 4px;
  flex: 1;
}
.validation-error {
  display: block;
  color: var(--dark-danger);
  font-size: 0.8rem;
  margin-top: -15px;
  margin-bottom: 10px;
  opacity: 1;
  height: auto;
  transform: none;
}
.validation-error.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
}
.confirm-status {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 14px;
}
.confirm-time {
  font-size: 11px;
  color: #aaa;
}
#gomaps-widget {
  position: relative;
  max-width: 100%;
}

.validation-error {
  color: #e74c3c;
  font-size: 0.9rem;
  margin-top: 4px;
}

#gomaps-distance {
  font-weight: bold;
  color: #2c3e50;
  font-size: 1.1rem;
}


.form-control.invalid {
    border-color: var(--dark-danger);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
}
@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 0.3; }
  100% { opacity: 0.6; }
}
        
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .close-modal {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 1.8rem;
            color: var(--dark-gray);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close-modal:hover {
            color: var(--dark-danger);
            transform: rotate(90deg);
        }
        
        .modal h2 {
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal h2 i {
            color: var(--dark-accent);
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            color: var(--dark-text);
            font-size: 1rem;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--dark-accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
/* Add to CSS */
.holiday {
  background: linear-gradient(rgba(255, 0, 0, 0.1), rgba(255, 0, 0, 0.2)) !important;
  border: 2px dashed #ff6b6b !important;
}

.holiday .day-number {
  color: #ff0000 !important;
  font-weight: 800 !important;
  text-decoration: underline;
}

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        .close-sidebar-mobile {
  position: absolute;
  top: 20px;
  right: 20px;
  display: none;
  background: none;
  border: none;
  color: var(--dark-gray);
  font-size: 1.5rem;
  z-index: 10;
}
.notification-status {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-left: 8px;
    background-color: var(--dark-danger); /* Default to disabled (red) */
}
.notification-status.enabled {
    background-color: var(--dark-success); /* Enabled (green) */
}
.notification-enabled {
    background-color: var(--dark-success);
}

.notification-disabled {
    background-color: var(--dark-danger);
}
        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar .brand h2, .sidebar .nav-links a span {
                display: none;
            }
            
            .sidebar .brand {
                padding: 25px 15px;
                justify-content: center;
            }
            
            .sidebar .nav-links a {
                justify-content: center;
                padding: 18px 15px;
            }
            
            .sidebar .nav-links a i {
                margin-right: 0;
                font-size: 1.4rem;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .header {
                left: 80px;
            }
        }
        
        @media (max-width: 992px) {
            .card-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 33%;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
                flex-direction: column;
                height: auto;
                padding: 15px 0;
            }
            
            .header h2 {
                margin-bottom: 15px;
            }
            
            .main-content {
                padding: 20px 15px;
                padding-top: 110px;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                flex: 1;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, minmax(40px, 1fr));
                gap: 8px;
            }
            
            .calendar-day {
                min-height: 90px;
                padding: 10px;
            }
            
            .appointment-item {
                padding: 6px;
                font-size: 0.7rem;
            }
            
            .modal-content {
                width: 95%;
                padding: 25px;
            }
            @media (max-width: 768px) {
    /* Mobile card layout */
    .card-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .card {
        padding: 20px;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .card-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    .card-content {
        font-size: 1.8rem;
        margin: 8px 0;
    }
    
    .card-footer {
        font-size: 0.8rem;
    }
    
    /* Chart height adjustment */
    #appointmChart {
        height: 280px !important;
    }
}
        }
        
        @media (max-width: 576px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                z-index: 2000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .header {
                left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 15px;
                left: 20px;
                z-index: 1500;
                background: var(--dark-accent);
                color: white;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            }
            .calendar-grid {
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    overflow-x: auto;
    padding-bottom: 10px;
  }
  
  .calendar-day {
    min-height: 80px;
    padding: 8px;
    font-size: 0.8rem;
  }
  
  .appointment-item {
    font-size: 0.65rem;
    padding: 4px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .day-number {
    font-size: 0.9rem;
    margin-bottom: 5px;
  }

        }
        
        /* Mobile menu button */
        .mobile-menu-btn {
  background: none !important;
  box-shadow: none !important;
  width: auto;
  height: auto;
  color: var(--dark-accent);
}

.mobile-menu-btn:hover {
  transform: none;
  color: var(--dark-text);
}
        .mobile-menu-btn {
  display: block;
  cursor: pointer;
}

/* Hide hamburger menu on screens wider than 768px */
@media (min-width: 768px) {
  .mobile-menu-btn {
    display: none;
  }
}
@media (max-width: 576px) {
  .sidebar.active .brand h2,
  .sidebar.active .nav-links a span {
    display: inline-block !important;
    animation: fadeIn 0.3s ease;
  }
  .sidebar.active .nav-links a {
    justify-content: flex-start;
    padding: 16px 30px;
  }
  .close-sidebar-mobile {
    display: block;
  }
}
@media (max-width: 480px) {
  .modal-content {
    padding: 20px 15px;
    width: 95%;
  }
  
  .appointment-details {
    font-size: 0.9rem;
  }
  
  .appointment-details p {
    margin-bottom: 10px;
  }
  .card {
        padding: 15px;
    }
    
    .card-content {
        font-size: 1.6rem;
    }
}
#address-suggestions {
  position: absolute;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  width: 100%;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#address-suggestions li {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

#address-suggestions li:hover {
  background-color: #f5f5f5;
}
.suggestion-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
  transition: background-color 0.2s;
}

.suggestion-item:hover {
  background-color: #f5f5f5;
}

.validation-error {
  color: #e74c3c;
  font-size: 0.85rem;
  margin-top: 5px;
  display: block;
}
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <div class="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"><i class="fas fa-spinner"></i></div>
        <div>Loading dashboard...</div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-dumbbell"></i>
            <h2>Fitness Repair</h2>
        </div>
        <!-- Sidebar -->
        <button class="close-sidebar-mobile">
            <i class="fas fa-times"></i>
          </button>

        <div class="nav-links">
            <a href="#" data-view="dashboard" class="active">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" data-view="appointments">
                <i class="fas fa-calendar-check"></i>
                <span>Appointments</span>
            </a>
            <a href="#" data-view="calendar">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </a>
            <a href="#" data-view="customers">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </a>
            <a href="#" data-view="reports">
                <i class="fas fa-chart-pie"></i>
                <span>Reports</span>
            </a>
            <a href="#" data-view="logs">
                <i class="fas fa-clipboard-list"></i>
                <span>Logs</span>
              </a>
              
            <a href="#" data-view="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
            <a href="#" data-view="help">
                <i class="fas fa-question-circle"></i>
                <span>Help Center</span>
            </a>
            <a href="#" data-view="logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div>
                        <div id="user-name">admin@fitnessrepair.com</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="tab-content active">
 
            <div class="card-grid">
                <div class="card" id="total-appointments-card" data-status="All">
                    <div class="card-header">
                        <div class="card-title">Total Appointments</div>
                        <div class="card-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                    </div>
                    <div class="card-content" id="total-appointments">0</div>
                    <div class="card-footer">
                        <i class="fas fa-arrow-up"></i> <span id="total-appointments-text">Loading...</span>
                    </div>
                </div>
                
                <div class="card" id="scheduled-card" data-status="Scheduled / Confirmed">
                    <div class="card-header">
                        <div class="card-title">Scheduled</div>
                        <div class="card-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="card-content" id="scheduled-count">0</div>
                    <div class="card-footer">
                        <i class="fas fa-plus"></i> <span id="scheduled-text">Loading...</span>
                    </div>
                </div>
                
                <div class="card" id="inprogress-card" data-status="In Progress">
                    <div class="card-header">
                        <div class="card-title">In Progress</div>
                        <div class="card-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                    </div>
                    <div class="card-content" id="inprogress-count">0</div>
                    <div class="card-footer">
                        <i class="fas fa-exclamation-triangle"></i><span id="inprogress-text">Loading...</span>
                    </div>
                </div>
                
                <div class="card" id="completed-card" data-status="Completed">
                    <div class="card-header">
                        <div class="card-title">Completed</div>
                        <div class="card-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="card-content" id="released-count">0</div>
                    <div class="card-footer">
                        <i class="fas fa-arrow-up"></i><span id="completed-text">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Appointments Overview</div>
                    <div class="card-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                </div>
                <div style="height: 350px;">
                    <canvas id="appointmentsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Appointments View -->
        <div id="appointments-view" class="tab-content">
            <div style="margin-bottom: 25px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <button id="add-appointment" class="btn">
                    <i class="fas fa-plus"></i> Add Appointment
                </button>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <input type="text" id="search-appointments" class="form-control" placeholder="Search appointments..." style="min-width: 250px;">
                    <button class="btn" id="print-schedule"><i class="fas fa-print"></i> Print</button>
                    <button id="export-appointments" class="btn secondary">
                        <i class="fas fa-file-export"></i> Export CSV
                      </button>                      
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Equipment</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Price</th>
                            <th>Confirm</th>
                            <th>Actions</th>
                            <th>Directions</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading appointments...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; flex-wrap: wrap; gap: 15px;">
                <button id="prev-page" class="btn secondary" disabled>Previous</button>
                <div id="page-indicator">Page 1 of 1</div>
                <button id="next-page" class="btn" disabled>Next</button>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendar-view" class="tab-content">
            <div class="calendar-header">
                <h2 id="current-month-year">Loading...</h2>
                <div class="calendar-nav">
                    <button id="prev-month" class="btn secondary"><i class="fas fa-chevron-left"></i> Prev</button>
                    <button id="next-month" class="btn">Next <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Month Summary</div>
                        <div class="card-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div>
                            <div class="card-content" id="summary-total">0</div>
                            <div class="card-footer">Total Appointments</div>
                        </div>
                        <div>
                            <div class="card-content" id="summary-days">0</div>
                            <div class="card-footer">Business Days</div>
                        </div>
                        <div>
                            <div class="card-content" id="summary-revenue">$0</div>
                            <div class="card-footer">Revenue</div>
                        </div>
                        <div>
                            <div class="card-content" id="summary-utilization">0%</div>
                            <div class="card-footer">Utilization</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance Metrics</div>
                        <div class="card-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div>
                            <div class="card-content" id="current-appointments">0</div>
                            <div class="card-footer">Current</div>
                        </div>
                        <div>
                            <div class="card-content" id="monthly-released">0</div>
                            <div class="card-footer">Completed</div>
                        </div>
                        <div>
                            <div class="card-content" id="monthly-revenue">$0</div>
                            <div class="card-footer">Revenue</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendar-days">
                <!-- Calendar days will be populated dynamically -->
            </div>
        </div>

        <!-- Customers View -->
        <div id="customers-view" class="tab-content">
            <div style="margin-bottom: 25px;">
                <button id="add-customer" class="btn">
                    <i class="fas fa-user-plus"></i> Add Customer
                </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Equipment</th>
                            <th>Last Appointment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading customers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="reports-view" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Performance Reports</div>
                    <div class="card-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="card">
                            <div class="card-content" style="font-size: 2.5rem;">$4,280</div>
                            <div class="card-footer">Monthly Revenue</div>
                        </div>
                        <div class="card">
                            <div class="card-content" style="font-size: 2.5rem;">42</div>
                            <div class="card-footer">Completed Repairs</div>
                        </div>
                        <div class="card">
                            <div class="card-content" style="font-size: 2.5rem;">78%</div>
                            <div class="card-footer">Utilization Rate</div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">Repair Completion Time</div>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="repairTimeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Revenue by Equipment Type</div>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn">
                            <i class="fas fa-file-export"></i> Export Report (PDF)
                        </button>
                        <button class="btn secondary" style="margin-left: 15px;">
                            <i class="fas fa-download"></i> Download Data (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Logs View -->
        <div id="logs-view" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Activity Logs</div>
                    <div class="card-icon">
                    <i class="fas fa-clipboard-list"></i>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                    <thead>
                        <tr>
                        <th>Type</th>
                        <th>Appointment ID</th>
                        <th>Email</th>
                        <th>SMS</th>
                        <th>Status</th>
                        <th>Timestamp</th>
                        <th>Error</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body">
                        <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            <i class="fas fa-spinner fa-spin"></i> Loading logs...
                        </td>
                        </tr>
                    </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <button id="prev-log-page" class="btn secondary">Previous</button>
                    <div id="log-page-indicator">Page 1</div>
                    <button id="next-log-page" class="btn">Next</button>
                  </div>                  
            </div>
        </div>
  
        <div id="settings-view" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Account Settings</div>
                    <div class="card-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <form id="settings-form">
                        <h3 style="margin-bottom: 15px; color: var(--dark-accent);">Profile</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label>Full Name</label>
                                <input type="text" id="settings-full-name" class="form-control" placeholder="Enter your name">
                                <div class="validation-error" id="settings-full-name-error"></div>
                            </div>
                            <div>
                                <label>Email</label>
                                <input type="email" id="settings-email" class="form-control" placeholder="Enter your email" disabled>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 15px; color: var(--dark-accent);">Business Settings</h3>
                        <div style="margin-bottom: 20px;">
                            <label>Business Name</label>
                            <input type="text" id="settings-business-name" class="form-control" placeholder="Enter business name">
                            <div class="validation-error" id="settings-business-name-error"></div>
                        </div>
                        
                        <!-- NEW: Province Selection -->
                        <div style="margin-bottom: 20px;">
                            <label>Business Province</label>
                            <select id="business-province" class="form-control">
                                <option value="ON">Ontario</option>
                                <option value="QC">Quebec</option>
                                <option value="BC">British Columbia</option>
                                <option value="AB">Alberta</option>
                                <option value="MB">Manitoba</option>
                                <option value="SK">Saskatchewan</option>
                                <option value="NS">Nova Scotia</option>
                                <option value="NB">New Brunswick</option>
                                <option value="NL">Newfoundland and Labrador</option>
                                <option value="PE">Prince Edward Island</option>
                                <option value="NT">Northwest Territories</option>
                                <option value="NU">Nunavut</option>
                                <option value="YT">Yukon</option>
                            </select>
                        </div>
                        
                        <!-- NEW: Timezone Selection -->
                        <div style="margin-bottom: 20px;">
                            <label>Business Timezone</label>
                            <select id="timezone" class="form-control">
                                <option value="America/Toronto">Eastern (Toronto)</option>
                                <option value="America/Vancouver">Pacific (Vancouver)</option>
                                <option value="America/Edmonton">Mountain (Edmonton)</option>
                                <option value="America/Winnipeg">Central (Winnipeg)</option>
                                <option value="America/Halifax">Atlantic (Halifax)</option>
                                <option value="America/St_Johns">Newfoundland (St. John's)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label>Business Hours</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <input type="time" id="settings-start-time" class="form-control">
                                    <div class="card-footer" style="text-align: center; padding: 5px;">Opening Time</div>
                                </div>
                                <div>
                                    <input type="time" id="settings-end-time" class="form-control">
                                    <div class="card-footer" style="text-align: center; padding: 5px;">Closing Time</div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 15px; color: var(--dark-accent);">Notification Preferences</h3>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="email-notifications" checked>
                                <label for="email-notifications">Email Notifications
                                <span id="email-notification-status" class="notification-status"></span>
                                </label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="sms-notifications">
                                <label for="sms-notifications">SMS Notifications
                                <span id="sms-notification-status" class="notification-status"></span>
                                <button type="button" id="test-sms-btn" class="btn" style="margin-left: 15px;">
                                    <i class="fas fa-paper-plane"></i> Test SMS
                                </button>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label>Admin Phone Number (for SMS)</label>
                            <input type="tel" id="admin-phone" class="form-control" placeholder="e.g., 4161234567">
                            <div class="validation-error" id="admin-phone-error"></div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label>Mobile Carrier (for SMS Notifications)</label>
                            <select id="sms-carrier" class="form-control">
                                <option value="rogers">Rogers</option>
                                <option value="bell">Bell</option>
                                <option value="telus">Telus</option>
                                <option value="fido">Fido</option>
                                <option value="virgin">Virgin Mobile</option>
                                <option value="koodo">Koodo</option>
                                <option value="freedom">Freedom Mobile</option>
                                <option value="public">Public Mobile</option>
                                <option value="sasktel">SaskTel</option>
                                <option value="videotron">Videotron</option>
                            </select>
                        </div>
        
                        <div class="form-actions">
                            <button type="button" id="save-settings" class="btn">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button type="button" id="cancel-settings" class="btn secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="help-view" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Help Center</div>
                    <div class="card-icon">
                        <i class="fas fa-question-circle"></i>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--dark-accent);">Frequently Asked Questions</h3>
                    
                    <div class="faq-item" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--dark-border);">
                        <div style="font-weight: bold; margin-bottom: 5px;">How do I reschedule an appointment?</div>
                        <div>Go to the Appointments view, click the edit button next to the appointment, and change the date/time.</div>
                    </div>
                    
                    <div class="faq-item" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--dark-border);">
                        <div style="font-weight: bold; margin-bottom: 5px;">How do I add a new customer?</div>
                        <div>Go to the Customers view and click the "Add Customer" button.</div>
                    </div>
                    
                    <div class="faq-item" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--dark-border);">
                        <div style="font-weight: bold; margin-bottom: 5px;">How do I print the daily schedule?</div>
                        <div>In the Appointments view, use the "Print" button at the top right.</div>
                    </div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--dark-accent);">Contact Support</h3>
                    
                    <form id="support-form">
                        <div style="margin-bottom: 20px;">
                            <label>Subject</label>
                            <input type="text" id="support-subject" class="form-control">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label>Message</label>
                            <textarea class="form-control" id="support-message" rows="4"></textarea>
                        </div>
                        
                        <button class="btn">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </form>
                    
                    <div style="margin-top: 30px; background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px;"><i class="fas fa-phone-alt"></i> Phone Support</h4>
                        <div>1-289-925-7239 (9am-5pm EST)</div>
                        
                        <h4 style="margin-top: 20px; margin-bottom: 10px;"><i class="fas fa-envelope"></i> Email Support</h4>
                        <div>canadianfitnessrepair@gmail.com</div>
                    </div>
                </div>
            </div>
        </div>           
    </div>

<!-- Appointment Modal -->
<div id="appointment-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 id="modal-title"><i class="fas fa-calendar-plus"></i> Add New Appointment</h2>
      <form id="appointment-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <label>Customer Name</label>
            <input type="text" id="customer-name" class="form-control" placeholder="Enter customer name" required>
            <div class="validation-error" id="customer-name-error"></div>
          </div>
          <div>
            <label>Phone Number</label>
            <input type="tel" id="customer-phone" class="form-control" placeholder="Enter phone number">
          </div>
        </div>
        
        <!-- ✅ Email Address Field -->
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="customer-email">Email Address</label>
          <input type="email" id="customer-email" class="form-control" placeholder="example@email.com">
        </div>
  
        <!-- ✅ Carrier Dropdown -->
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="customer-carrier">Carrier</label>
          <select id="customer-carrier" class="form-control">
            <option value="">-- Select Carrier --</option>
            <option value="rogers">Rogers</option>
            <option value="bell">Bell</option>
            <option value="telus">Telus</option>
            <option value="fido">Fido</option>
            <option value="virgin">Virgin</option>
            <option value="koodo">Koodo</option>
            <option value="freedom">Freedom</option>
            <option value="chatr">Chatr</option>
            <option value="public">Public Mobile</option>
            <option value="sasktel">SaskTel</option>
            <option value="videotron">Videotron</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
        
        <!-- ✅ Lookup Carrier Button -->
        <div class="form-group" style="margin-bottom: 20px;">
          <button type="button" class="btn btn-secondary" id="lookup-carrier">Lookup Carrier</button>
        </div>
        
        <div style="margin-bottom: 20px; position: relative;">
            <label for="house-address-input">House Address</label>
          
            <!-- Visible input for user typing -->
            <input
              type="text"
              id="house-address-input"
              class="form-control"
              name="houseAddress"
              placeholder="Enter house address"
              required
              autocomplete="off"
              style="margin-bottom: 10px; padding: 8px; width: 100%; box-sizing: border-box;"
            />
            <ul id="address-suggestions" style="
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            list-style: none;
            margin: 0;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
          "></ul>          

          
            <!-- GoMaps widget container: just for the map & autocomplete UI -->
            <div
            id="gomaps-widget"
            data-api-key="AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c"
            data-label="Start typing your address..."
            data-map="true"
            data-map-height="200px"
            data-distance-from="22 Canary Grass Blvd, Hamilton, Ontario, L0R 1P0"
            data-output-id="house-address-input"
            style="margin-bottom: 10px;"
          ></div>
          
            <div class="validation-error" id="house-address-error"></div>
          
            <p>
              <strong>Distance:</strong> <span id="gomaps-distance" style="color: inherit;">0</span> km
            </p>
          </div>
          
          
  

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <label>Date</label>
            <input type="date" id="appointment-date" class="form-control" required>
            <div class="validation-error" id="appointment-date-error"></div>
          </div>
          <div>
            <label>Time</label>
            <input type="time" id="appointment-time" class="form-control" required>
            <div class="validation-error" id="appointment-time-error"></div>
          </div>
        </div>
  
        <div style="margin-bottom: 20px;">
          <label>Equipment</label>
          <input type="text" id="equipment" class="form-control" placeholder="Enter equipment type">
          <div class="validation-error" id="equipment-error"></div>
        </div>
  
        <div class="form-group" style="margin-bottom: 20px;">
          <label>Service Price (before tax)</label>
          <input type="number" id="appointment-base-price" class="form-control" step="0.01" placeholder="0.00">
        </div>
  
        <div class="form-group" style="margin-bottom: 20px;">
          <label>Tax</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <input type="text" id="appointment-tax-rate" class="form-control" readonly>
              <div class="card-footer" style="text-align: center; padding: 5px;">Rate</div>
            </div>
            <div>
              <input type="number" id="appointment-tax-amount" class="form-control" readonly>
              <div class="card-footer" style="text-align: center; padding: 5px;">Amount</div>
            </div>
          </div>
        </div>
  
        <div class="form-group" style="margin-bottom: 20px;">
          <label>Total Price (including tax)</label>
          <input type="number" id="appointment-price" class="form-control" readonly>
        </div>
  
        <div style="margin-bottom: 20px;">
          <label>Issue Description</label>
          <textarea id="issue-description" class="form-control" placeholder="Describe the issue"></textarea>
          <div class="validation-error" id="issue-description-error"></div>
        </div>
  
        <div style="margin-bottom: 20px;">
          <label>Repair Notes</label>
          <textarea id="repair-notes" class="form-control" placeholder="Add repair notes"></textarea>
          <div class="validation-error" id="repair-notes-error"></div>
        </div>
  
        <div style="margin-bottom: 20px;">
            <label>Status</label>
            <select id="appointment-status" class="form-control">
              <option value="Scheduled / Confirmed">📅 Scheduled / Confirmed</option>
              <option value="In Progress">🔧 In Progress</option>
              <option value="Awaiting Parts">⏳ Awaiting Parts</option>
              <option value="Parts Arrived">📦 Parts Arrived</option>
              <option value="Scheduled for Parts Installation">🛠️ Install Scheduled</option>
              <option value="Repaired">✅ Repaired</option>
              <option value="Completed">🏁 Completed</option>
              <option value="Cancelled">❌ Cancelled</option>
            </select>
          </div>
          

        <div style="margin-bottom: 20px;">
            <label>
              <input type="checkbox" id="reminder-enabled" />
              Send reminder 24 hours before appointment
            </label>
          </div>       
          
        <div class="form-actions">
          <button type="button" id="save-appointment" class="btn">Save Appointment</button>
          <button type="button" id="cancel-appointment" class="btn secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

<!-- Customer Modal -->
<div id="customer-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="customer-modal-title"><i class="fas fa-user-plus"></i> Add New Customer</h2>
        <form id="customer-form">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label>Full Name</label>
                    <input type="text" id="customer-modal-name" class="form-control" placeholder="Enter full name" required>
                    <span id="name-error" class="error-message"></span> <!-- Error message for full name -->
                </div>
                <div>
                    <label>Phone Number</label>
                    <input type="tel" id="customer-modal-phone" class="form-control" placeholder="Enter phone number (e.g., 5555555555)">
                    <span id="phone-error" class="error-message"></span> <!-- Error message for phone -->
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Email Address</label>
                <input type="email" id="customer-modal-email" class="form-control" placeholder="Enter email address (e.g., example@domain.com)">
                <span id="email-error" class="error-message"></span> <!-- Error message for email -->
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Address</label>
                <input type="text" id="customer-modal-address" class="form-control" placeholder="Enter address">
                <span id="address-error" class="error-message"></span> <!-- Error message for address -->
            </div>

            <!-- New Equipment Field -->
            <div style="margin-bottom: 20px;">
                <label>Equipment</label>
                <input type="text" id="customer-modal-equipment" class="form-control" placeholder="Enter equipment (e.g., Treadmill)">
                <span id="equipment-error" class="error-message"></span> <!-- Error message for equipment -->
            </div>

            <!-- New Last Appointment Field -->
            <div style="margin-bottom: 20px;">
                <label>Last Appointment Date</label>
                <input type="date" id="customer-modal-last-appointment" class="form-control">
                <span id="last-appointment-error" class="error-message"></span> <!-- Error message for last appointment -->
            </div>

            <div style="margin-bottom: 20px;">
                <label>Notes</label>
                <textarea id="customer-modal-notes" class="form-control" placeholder="Add customer notes"></textarea>
                <span id="notes-error" class="error-message"></span> <!-- Error message for notes -->
            </div>
            
            <!-- Loading spinner (hidden initially) -->
            <div id="loading-spinner" class="spinner" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Saving...
            </div>

            <div class="form-actions">
                <button type="button" id="save-customer" class="btn">Save Customer</button>
                <button type="button" id="cancel-customer" class="btn secondary">Cancel</button>
                <!-- Reset button to clear form -->
                <button type="button" id="reset-customer" class="btn secondary">Reset Form</button>
            </div>
        </form>
    </div>
</div>


    <!-- Preview Message Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" id="close-preview-icon">&times;</span>
            <h2 id="previewModalTitle">📩 Message Preview</h2>
            <small id="previewTypeLabel" style="color: gray; margin-left: 5px;"></small>            
    
        <h4>Email Preview</h4>
        <textarea id="emailPreview" class="form-control" rows="10" readonly></textarea>
    
        <h4 style="margin-top: 20px;">SMS Preview</h4>
        <textarea id="smsPreview" class="form-control" rows="4" readonly></textarea>
        <small id="smsCharCount" style="color: gray; display: block; margin-top: 4px;">
            0 / 160 characters
          </small>          
        <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
            <button id="editPreviewBtn" class="btn secondary" onclick="enableEditing()">✏️ Edit</button>
            <button id="savePreviewBtn" class="btn primary" style="display: none;" onclick="saveEditedPreview()">💾 Save Changes</button>
            <button id="resetPreviewBtn" class="btn danger" disabled>🗑 Reset to Default</button>
            <button class="btn" id="close-preview-btn">❌ Close</button>
          </div>          
        </div>
    </div>
  
    <!-- Firebase Script -->
    <script type="module">
        console.log("✅ Admin dashboard initialized");
        
        // ================ FIREBASE INITIALIZATION ================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            orderBy,
            limit,
            Timestamp,
            query,
            where,
            setDoc,
            getDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        let allLogs = [];
        let currentLogPage = 1;
        const logsPerPage = 20;
        let db;
        let auth, appointmentsCollection;
        let map = null;
        let marker = null;

        async function getFirebaseConfig() {
            try {
                const response = await fetch(
                    "https://cfr-backend-1.onrender.com/api/firebase-config"
                );
                return await response.json();
            } catch (error) {
                console.error("Error fetching Firebase config:", error);
                showToast("Failed to initialize Firebase", true);
                return null;
            }
        }
    
        (async () => {
            const firebaseConfig = await getFirebaseConfig();
            if (!firebaseConfig) {
                showToast("App configuration failed to load.", true);
                return;
            }
    
            const app = initializeApp(firebaseConfig);
             db = getFirestore(app);
             auth = getAuth(app);
                appointmentsCollection = collection(db, "appointments");

            const customersCollection = collection(db, "customers");
 
            initApp(auth, db, appointmentsCollection, customersCollection);
        })();
        // ===== CACHING MECHANISM =====
    let cachedAppointments = null;
    let lastFetchTime = 0;
    let originalAppointmentData = {};
    let currentPreviewAppointment = null;
    let originalEmail = "";
    let originalSMS = "";
    let statusFilter = "All"; // Default filter
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
    // Your fixed base address (starting point)
    const baseAddress = "22 Canary Grass Blvd, Hamilton, Ontario, L0R 1P0";

    const apiKey = document.getElementById('gomaps-widget').dataset.apiKey;
    const routeMapDiv = document.getElementById('route-map');

    let routeMap;
    let routeLine;
    // ===== ERROR HANDLING FOR FIREBASE =====
    async function initializeFirebaseWithRetry(retries = 3, delay = 2000) {
      try {
        const firebaseConfig = await getFirebaseConfig();
        if (!firebaseConfig) throw new Error("Invalid Firebase config");
        
        const app = initializeApp(firebaseConfig);
        return {
          db: getFirestore(app),
          auth: getAuth(app),
          appointmentsCollection: collection(getFirestore(app), "appointments"),
          customersCollection: collection(getFirestore(app), "customers")
        };
      } catch (error) {
        if (retries > 0) {
          console.log(`Retrying Firebase initialization... (${retries} left)`);
          await new Promise(resolve => setTimeout(resolve, delay));
          return initializeFirebaseWithRetry(retries - 1, delay * 2);
        }
        throw error;
      }
    }
function setupStatusCardClickHandlers() {
    // Select all cards in the grid
    document.querySelectorAll('.card-grid .card').forEach(card => {
        card.addEventListener('click', function() {
            // Get the status value from the card's data-status attribute
            const status = this.getAttribute('data-status');
            
            // Update the global statusFilter variable
            statusFilter = status;
            
            // Set the dropdown value to match the card's status
            const statusDropdown = document.getElementById('appointment-status');
            if (statusDropdown) {
                statusDropdown.value = status;  // Update the dropdown value to the selected status
            }
            
            // Activate the "appointments" view with filtered appointments
            activateView("appointments");
            fetchAppointments();
        });
    });
}


    // ===== PAGINATION FOR CUSTOMERS =====
    let currentCustomerPage = 1;
    const customersPerPage = 10;
    const statusMap = {
        "Scheduled / Confirmed": { text: "Scheduled / Confirmed", class: "status-scheduled", icon: "📅" },
        "In Progress": { text: "In Progress", class: "status-inprogress", icon: "🔧" },
        "Awaiting Parts": { text: "Awaiting Parts", class: "status-awaiting", icon: "⏳" },
        "Parts Arrived": { text: "Parts Arrived", class: "status-arrived", icon: "📦" },
        "Scheduled for Parts Installation": { text: "Install Scheduled", class: "status-install", icon: "🛠️" },
        "Repaired": { text: "Repaired", class: "status-repaired", icon: "✅" },
        "Completed": { text: "Completed", class: "status-complete", icon: "🏁" },
        "Cancelled": { text: "Cancelled", class: "status-cancelled", icon: "❌" }
        };
    const statusGroups = {
        "All": null, // no filtering
        "Scheduled / Confirmed": ["scheduled"],
        "In Progress": ["in_progress", "parts_ordered", "needs_parts"],
        "Completed": ["repair_completed", "released"], // if you use both
        "Cancelled": ["cancelled"]
        };

    async function saveAdminSettings(db) {
    const rawAdminPhone = document.getElementById("admin-phone").value.trim();
    const encryptedPhone = await encryptData(rawAdminPhone);

    const fullName = document.getElementById("settings-full-name").value.trim();
    const businessName = document.getElementById("settings-business-name").value.trim();
    const province = document.getElementById("business-province").value;
    const timeZone = document.getElementById("timezone").value;
    const smsNotifications = document.getElementById("sms-notifications").checked;
    const smsCarrier = document.getElementById("sms-carrier").value;

    const gst = parseFloat(document.getElementById("gst-rate").value || 0);
    const pst = parseFloat(document.getElementById("pst-rate").value || 0);
    document.addEventListener('DOMContentLoaded', function() {
    // Get status filter from URL if exists
    const urlParams = new URLSearchParams(window.location.search);
    const urlStatus = urlParams.get('status');
    
    if (urlStatus) {
        statusFilter = urlStatus;
        // Set the dropdown to match URL filter
        document.getElementById('status-filter').value = urlStatus;
    }
    
    // Initialize appointments
    fetchAppointments();
    setupStatusCardClickHandlers();
});
    // Clear previous errors
    document.querySelectorAll(".validation-error").forEach(el => {
        el.textContent = "";
        el.style.display = "none";
    });
    document.querySelectorAll(".form-control").forEach(field => {
        field.classList.remove("invalid");
    });
// Add click handlers to status cards
document.querySelectorAll('.card-grid .card').forEach(card => {
    card.addEventListener('click', function() {
        const status = this.getAttribute('data-status');
        
        // For the "Total Appointments" card, show all appointments
        const statusParam = status === 'All' ? '' : `?status=${encodeURIComponent(status)}`;
        
        // Navigate to appointments page with status filter
        window.location.href = `appointments.html${statusParam}`;
    });
});
    let isValid = true;

    // Validate required fields
    if (!fullName) {
        showValidationError("settings-full-name", "Full name is required");
        isValid = false;
    }
    if (!businessName) {
        showValidationError("settings-business-name", "Business name is required");
        isValid = false;
    }

    // ✅ Validate Canadian phone format
    if (rawAdminPhone && !validatePhone(rawAdminPhone)) {
        showValidationError("admin-phone", "Invalid Canadian phone format");
        isValid = false;
    }

    if (!isValid) return; // Stop if validation fails

    const adminSettings = {
        fullName,
        businessName,
        province,
        timeZone,
        smsNotifications,
        adminPhone: encryptedPhone,
        smsCarrier,
        gst,
        pst
    };

    try {
        await setDoc(doc(db, "settings", "admin"), adminSettings);  // Save to Firebase
        localStorage.setItem("fitnessRepairSettings", JSON.stringify(adminSettings));  // Save to browser
        showToast("Settings saved successfully");
    } catch (error) {
        console.error("❌ Error saving settings:", error);
        showToast("Failed to save settings", true);
    }
}
async function fetchSMSPreviewTemplate(appointment, type = "confirmation") {
  try {
    const res = await fetch(`https://cfr-backend-1.onrender.com/api/dev/preview-template?type=${type}&format=sms`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(appointment),
    });
    return await res.text();
  } catch (err) {
    console.error("❌ Failed to fetch SMS preview:", err);
    return `Your appointment with Canadian Fitness Repair is on ${appointment.date?.toDate?.()?.toLocaleDateString('en-CA') || '[DATE]'} at ${appointment.date?.toDate?.()?.toLocaleTimeString('en-CA', { hour: '2-digit', minute: '2-digit' }) || '[TIME]'}. Status: ${appointment.status || 'Scheduled'}. Call 289-925-7239.`;
  }
}

async function fetchEmailPreviewTemplate(appointment, type = "confirmation") {
  try {
    const res = await fetch(`https://cfr-backend-1.onrender.com/api/dev/preview-template?type=${type}&format=email`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(appointment),
    });
    return await res.text();
  } catch (err) {
    console.error("❌ Failed to fetch email preview:", err);
    return `Hi ${appointment.customer || 'Customer'},\n\nYour appointment is scheduled for ${appointment.date?.toDate?.()?.toLocaleDateString('en-CA')} at ${appointment.date?.toDate?.()?.toLocaleTimeString('en-CA', { hour: '2-digit', minute: '2-digit' })}. Equipment: ${appointment.equipment || '[Equipment]'}. Issue: ${appointment.issue || '[Issue]'}. Please contact 289-925-7239 to confirm.`;
  }
}
function initMap() {
            if (!map) {
                map = L.map('map-preview').setView([43.6532, -79.3832], 13); // Default to Toronto
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }
            return map;
        }
function formatCanadianAddress(address) {
    // Ensure standard Canadian format: [Street], [City], [Province] [Postal Code]
    return address
        .replace(/, QC, Canada$/, ', Québec, Canada')
        .replace(/, BC, Canada$/, ', British Columbia, Canada')
        .replace(/, ON, Canada$/, ', Ontario, Canada')
        // Add other provinces as needed
        .replace(/([A-Z]\d[A-Z]) (\d[A-Z]\d)/, '$1 $2'); // Fix postal code spacing
}
    async function fetchCustomers() {
      showLoading(true);
      try {
        const snapshot = await getDocs(customersCollection);
        customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderCustomersTable();
      } catch (error) {
        console.error("Error fetching customers:", error);
        showToast("Failed to load customers", true);
      } finally {
        showLoading(false);
      }
    }



        

        function displaySuggestions(suggestions) {
            const container = document.getElementById('address-suggestions');
            container.innerHTML = '';
            
            if (suggestions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = suggestion.display_name;
                item.onclick = () => {
                    selectSuggestion(suggestion);
                };
                container.appendChild(item);
            });
            
            container.style.display = 'block';
        }      

   

    function renderCustomersTable() {
      const tbody = document.getElementById('customers-body');
      tbody.innerHTML = '';
      
      if (customers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="no-data">No customers found</td></tr>`;
        return;
      }
      
      const start = (currentCustomerPage - 1) * customersPerPage;
      const pageCustomers = customers.slice(start, start + customersPerPage);
      
      pageCustomers.forEach(customer => {
        // ... existing customer row code
      });
      
      // Add pagination controls for customers
      const totalPages = Math.ceil(customers.length / customersPerPage);
      document.getElementById("customer-page-indicator").textContent = 
        `Page ${currentCustomerPage} of ${totalPages}`;
      
      document.getElementById("customer-prev-page").disabled = currentCustomerPage === 1;
      document.getElementById("customer-next-page").disabled = currentCustomerPage >= totalPages;
    }
    // ===== SEARCH FUNCTIONALITY FOR APPOINTMENTS =====
    function setupAdvancedSearch() {
      const searchInput = document.getElementById('search-appointments');
      searchInput.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        
        if (!term) {
          renderAppointmentsTable(appointments);
          return;
        }
        
        const filtered = appointments.filter(app => 
          app.customer.toLowerCase().includes(term) ||
          (app.phone && app.phone.toLowerCase().includes(term)) ||
          (app.equipment && app.equipment.toLowerCase().includes(term)) ||
          (app.status && statusMap[app.status]?.text.toLowerCase().includes(term))
        );
        
        renderAppointmentsTable(filtered);
      });
    }
    
    // ===== LOADING SKELETONS =====
    function showSkeletonLoader(containerId, rows = 5) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      for (let i = 0; i < rows; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton-row';
        skeleton.innerHTML = `
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
          <div class="skeleton-cell"></div>
        `;
        container.appendChild(skeleton);
      }
    }

    function showSuggestions(list) {
  const container = document.getElementById("address-suggestions");
  container.innerHTML = ""; // Clear previous results

  if (!list.length) {
    container.style.display = "none";
    return;
  }

  list.forEach(result => {
    const item = document.createElement("div");
    item.className = "suggestion-item"; // matches your CSS
    item.textContent = result.display_name;

    item.onclick = () => {
      document.getElementById("house-address-input").value = result.display_name;
      container.style.display = "none";

      // Parse lat/lon safely
      const lat = parseFloat(result.lat);
      const lon = parseFloat(result.lon);

      if (!isNaN(lat) && !isNaN(lon)) {
        showMap(lat, lon);
      } else {
        console.warn("Invalid coordinates:", result.lat, result.lon);
      }
    };

    container.appendChild(item);
  });

  container.style.display = "block";
}


    async function openPreviewModal(appointment) {
  currentPreviewAppointment = appointment;
  const docRef = doc(db, "appointments", appointment.id);
  const snap = await getDoc(docRef);
  const data = snap.data();

  // Determine preview type
  const wasConfirmed = !!appointment.confirmationSent;
  const lastStatus = appointment.lastStatusSent;
  const statusChanged = lastStatus && appointment.status !== lastStatus;
  const previewType = wasConfirmed && statusChanged ? "update" : "confirmation";

  // ✅ Show visual preview type label
const typeLabel = document.getElementById("previewTypeLabel");
if (typeLabel) {
  typeLabel.textContent = previewType === "update" ? "Repair Update Preview" : "Confirmation Preview";
  typeLabel.style.color = previewType === "update" ? "#e67e22" : "#3498db";
}


  const defaultSMS = await fetchSMSPreviewTemplate(appointment, previewType);
  const defaultEmail = await fetchEmailPreviewTemplate(appointment, previewType);

  const emailField = document.getElementById("emailPreview");
  const smsField = document.getElementById("smsPreview");

  originalEmail = data.editedEmailBody || defaultEmail;
  originalSMS = data.editedSmsBody || defaultSMS;

  // Convert HTML <br> to newlines and strip tags for textarea preview
  function htmlToPlainText(html) {
    return html
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<\/?[^>]+(>|$)/g, '')
      .trim();
  }

  emailField.value = htmlToPlainText(originalEmail);
  smsField.value = originalSMS;

  const resetBtn = document.getElementById("resetPreviewBtn");
  const hasCustom = !!(data.editedEmailBody || data.editedSmsBody);
  resetBtn.disabled = !hasCustom;

  emailField.readOnly = true;
  smsField.readOnly = true;
  document.getElementById("savePreviewBtn").style.display = "none";

  document.getElementById("previewModal").classList.add("active");

  const countLabel = document.getElementById("smsCharCount");
  const updateCharCount = () => {
    const len = smsField.value.length;
    countLabel.textContent = `${len} / 160 characters`;
    countLabel.style.color = len > 160 ? "red" : "gray";
  };

  updateCharCount();
  smsField.removeEventListener("input", updateCharCount); // no duplicate handlers
  smsField.addEventListener("input", updateCharCount);
}


function closePreviewModal() {
        document.getElementById("previewModal").classList.remove("active");
        }
        // ================ UTILITY FUNCTIONS ================
        function showLoading(show = true) {
            const loadingElement = document.getElementById('loading-overlay');
            if (loadingElement) {
                loadingElement.style.display = show ? 'flex' : 'none';
            }
        }
        
        function showToast(message, isError = false) {
          if (isError) {
            console.error(message);
          }
            const toast = document.createElement("div");
            toast.className = `toast ${isError ? "error" : "success"}`;
            toast.innerHTML = `
                <i class="fas ${isError ? "fa-exclamation-circle" : "fa-check-circle"}"></i>
                <div>${message}</div>
            `;
            document.getElementById("toast-container").appendChild(toast);
            
            setTimeout(() => toast.classList.add("show"), 100);
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function formatTimestamp(dateObj) {
            if (!dateObj) return "N/A";
            
            try {
                // Get timezone from settings or default to Toronto
                const settings = window.fitnessRepairSettings || {}
                const timeZone = settings.timeZone || 'America/Toronto';

                return dateObj.toLocaleString('en-CA', {
                    timeZone: timeZone,
                    hour12: true,
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error("Date formatting error:", e);
                return "Invalid Date";
            }
        }
        
        function showMap(lat, lon) {
  const mapContainer = document.getElementById("map-preview");
  mapContainer.innerHTML = `
    <iframe
      width="100%"
      height="200"
      frameborder="0"
      style="border:0"
      referrerpolicy="no-referrer-when-downgrade"
      src="https://www.openstreetmap.org/export/embed.html?bbox=${lon - 0.01},${lat - 0.01},${lon + 0.01},${lat + 0.01}&layer=mapnik&marker=${lat},${lon}"
      allowfullscreen>
    </iframe>
  `;
  mapContainer.style.display = "block";
}


        function getBusinessDays(month, year) {
            let count = 0;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(year, month, day);
                if (d.getDay() !== 0 && d.getDay() !== 6) count++;
            }
            return count;
        }
                // ================ HOLIDAY CALENDAR ================
                function getCanadianHolidays(year, province) {
    // Helper Functions
    function adjustToNextMonday(date) {
        const day = date.getDay();
        if (day === 0) return new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1); // Sunday → next Monday
        if (day === 6) return new Date(date.getFullYear(), date.getMonth(), date.getDate() + 2); // Saturday → next Monday
        return date;
    }

    function getEasterSunday(year) {
        const a = year % 19;
        const b = Math.floor(year / 100);
        const c = year % 100;
        const d = Math.floor(b / 4);
        const e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4);
        const k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const month = Math.floor((h + l - 7 * m + 114) / 31);
        const day = ((h + l - 7 * m + 114) % 31) + 1;
        return new Date(year, month - 1, day);
    }

    function getGoodFriday(year) {
        const easter = getEasterSunday(year);
        const goodFriday = new Date(easter);
        goodFriday.setDate(easter.getDate() - 2);
        return goodFriday;
    }

    function getNthMondayInMonth(n, year, month) {
        const firstDay = new Date(year, month, 1);
        const dayOfWeek = firstDay.getDay();
        const addDays = (dayOfWeek === 1) ? (n - 1) * 7 : (8 - dayOfWeek) % 7 + (n - 1) * 7;
        return new Date(year, month, 1 + addDays);
    }

    function getVictoriaDay(year) {
        const may24 = new Date(year, 4, 24);
        const dayOfWeek = may24.getDay();
        const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        return new Date(year, 4, 24 - diff);
    }

    function getNearestMonday(year, month, day) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        if (dayOfWeek === 0) return new Date(year, month, day + 1); // Sunday → next Monday
        return new Date(year, month, day - (dayOfWeek - 1)); // Move to Monday of the same week
    }



    // Common Federal Holidays (observed nationwide)
    const holidays = {
        NEW_YEAR: adjustToNextMonday(new Date(year, 0, 1)), // Jan 1
        GOOD_FRIDAY: getGoodFriday(year),
        CANADA_DAY: adjustToNextMonday(new Date(year, 6, 1)), // Jul 1
        LABOUR_DAY: getNthMondayInMonth(1, year, 8), // First Monday in September
        THANKSGIVING: getNthMondayInMonth(2, year, 9), // Second Monday in October
        CHRISTMAS: adjustToNextMonday(new Date(year, 11, 25)), // Dec 25
    };
    async function saveEditedPreview() {
  if (!currentPreviewAppointment) return;

  const email = document.getElementById("emailPreview").value.trim();
  const sms = document.getElementById("smsPreview").value.trim();

  const docRef = doc(db, "appointments", currentPreviewAppointment.id);

  try {
    await updateDoc(docRef, {
      editedEmailBody: email,
      editedSmsBody: sms
    });

    showToast("✅ Message saved successfully.");
    closePreviewModal();
  } catch (err) {
    console.error("❌ Failed to save preview:", err);
    showToast("Failed to save message", "error");
  }
}
function enableEditing() {
  const emailField = document.getElementById("emailPreview");
  const smsField = document.getElementById("smsPreview");
  const saveBtn = document.getElementById("savePreviewBtn");

  emailField.readOnly = false;
  smsField.readOnly = false;
  saveBtn.style.display = "inline-block";
  saveBtn.disabled = true;

  function checkChanges() {
    const email = emailField.value.trim();
    const sms = smsField.value.trim();
    saveBtn.disabled = (email === originalEmail.trim() && sms === originalSMS.trim());
  }

  emailField.addEventListener("input", checkChanges);
  smsField.addEventListener("input", checkChanges);
}
function updateSMSCharCount() {
  const sms = document.getElementById("smsPreview").value;
  document.getElementById("smsCharCount").textContent = `${sms.length} / 160 characters`;
}

    // Province-Specific Holidays
    switch(province) {
        case 'AB': // Alberta
            holidays.FAMILY_DAY = getNthMondayInMonth(3, year, 1); // Third Mon in Feb
            holidays.VICTORIA_DAY = getVictoriaDay(year);
            break;
        case 'BC': // British Columbia
            holidays.FAMILY_DAY = getNthMondayInMonth(3, year, 1);
            holidays.BC_DAY = getNthMondayInMonth(1, year, 7); // First Mon in Aug
            holidays.VICTORIA_DAY = getVictoriaDay(year);
            break;
        case 'MB': // Manitoba
            holidays.LOUIS_RIEL_DAY = getNthMondayInMonth(3, year, 1); // Third Mon in Feb
            holidays.CIVIC_HOLIDAY = getNthMondayInMonth(1, year, 7); // First Mon in Aug
            holidays.VICTORIA_DAY = getVictoriaDay(year);
            break;
        case 'NB': // New Brunswick
            holidays.FAMILY_DAY = getNthMondayInMonth(3, year, 1);
            holidays.NEW_BRUNSWICK_DAY = getNthMondayInMonth(1, year, 7);
            holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26)); // Dec 26
            break;
        case 'NL': // Newfoundland & Labrador
            holidays.ST_PATRICKS_DAY = getNearestMonday(year, 2, 17); // Nearest Mon to Mar 17
            holidays.ST_GEORGES_DAY = getNearestMonday(year, 3, 23); // Nearest Mon to Apr 23
            holidays.DISCOVERY_DAY = getNearestMonday(year, 5, 24); // Nearest Mon to Jun 24
            holidays.ORANGEMENS_DAY = getNearestMonday(year, 6, 12); // Nearest Mon to Jul 12
            holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26));
            break;
        case 'NS': // Nova Scotia
            holidays.HERITAGE_DAY = getNthMondayInMonth(3, year, 1); // Third Mon in Feb
            holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26));
            break;
        case 'NT': // Northwest Territories
            holidays.CIVIC_HOLIDAY = getNthMondayInMonth(1, year, 7);
            holidays.VICTORIA_DAY = getVictoriaDay(year);
            holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26));
            break;
        case 'NU': // Nunavut
            holidays.CIVIC_HOLIDAY = getNthMondayInMonth(1, year, 7);
            holidays.NUNAVUT_DAY = adjustToNextMonday(new Date(year, 6, 9)); // Jul 9
            holidays.VICTORIA_DAY = getVictoriaDay(year);
            holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26));
            break;
        case 'ON': // Ontario
            holidays.FAMILY_DAY = getNthMondayInMonth(3, year, 1);
            holidays.CIVIC_HOLIDAY = getNthMondayInMonth(1, year, 7);
            holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26));
            break;
        case 'PE': // Prince Edward Island
            holidays.ISLANDER_DAY = getNthMondayInMonth(3, year, 1); // Third Mon in Feb
            holidays.CIVIC_HOLIDAY = getNthMondayInMonth(1, year, 7);
            break;
        case 'QC': // Quebec
            holidays.NATIONAL_PATRIOTS_DAY = getVictoriaDay(year); // Same as Victoria Day
            holidays.ST_JEAN_BAPTISTE_DAY = adjustToNextMonday(new Date(year, 5, 24)); // Jun 24
            break;
        case 'SK': // Saskatchewan
            holidays.FAMILY_DAY = getNthMondayInMonth(3, year, 1);
            holidays.SASKATCHEWAN_DAY = getNthMondayInMonth(1, year, 7);
            break;
        case 'YT': // Yukon
            holidays.DISCOVERY_DAY = getNthMondayInMonth(3, year, 7); // Third Mon in Aug
            holidays.YUKON_HERITAGE_DAY = new Date(year, 1, 1 + (8 - new Date(year, 1, 1).getDay()) % 7 + 14); // Third Fri in Feb
            holidays.VICTORIA_DAY = getVictoriaDay(year);
            holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26));
            break;
    }

    // Conditional Holidays (based on province)
    const victoriaDayProvinces = ['AB', 'BC', 'MB', 'NT', 'NU', 'ON', 'SK', 'YT'];
    if (victoriaDayProvinces.includes(province)) {
        holidays.VICTORIA_DAY = getVictoriaDay(year);
    }

    const remembranceDayProvinces = ['AB', 'BC', 'MB', 'NT', 'NU', 'PE', 'SK', 'YT', 'NL', 'NB'];
    if (remembranceDayProvinces.includes(province)) {
        holidays.REMEMBRANCE_DAY = adjustToNextMonday(new Date(year, 10, 11)); // Nov 11
    }

    const boxingDayProvinces = ['ON', 'NB', 'NL', 'NS', 'NT', 'NU', 'YT'];
    if (boxingDayProvinces.includes(province)) {
        holidays.BOXING_DAY = adjustToNextMonday(new Date(year, 11, 26));
    }

    return holidays;
}
function validatePhone(phone) {
  // Remove spaces, dashes, parentheses, and plus
  const cleanPhone = phone.replace(/[\s\-+()]/g, '');
  // Match: 1 (optional), valid Canadian area codes and 7-digit numbers
  return /^1?[2-9]\d{2}[2-9]\d{6}$/.test(cleanPhone);
}
        // ================ TAX CALCULATION ================
        function getTaxRate(province) {
            const taxRates = {
                'ON': 0.13,  // Ontario HST
                'QC': 0.14975, // Quebec GST + QST
                'BC': 0.12,   // British Columbia GST + PST
                'AB': 0.05,   // Alberta GST
                'MB': 0.12,   // Manitoba GST + PST
                'SK': 0.11,   // Saskatchewan GST + PST
                'NS': 0.15,   // Nova Scotia HST
                'NB': 0.15,   // New Brunswick HST
                'NL': 0.15,   // Newfoundland and Labrador HST
                'PE': 0.15,   // Prince Edward Island HST
                'NT': 0.05,   // Northwest Territories GST
                'NU': 0.05,   // Nunavut GST
                'YT': 0.05    // Yukon GST
            };
            return taxRates[province] || 0.13; // Default to Ontario rate
        }
    
        function calculateTax() {
            const settings = window.fitnessRepairSettings || {};
            const province = settings.province || 'ON';
            const taxRate = getTaxRate(province);
            
            const basePrice = parseFloat(document.getElementById('appointment-base-price').value) || 0;
            const taxAmount = Math.round(basePrice * taxRate * 100) / 100;
            const totalPrice = Math.round((basePrice + taxAmount) * 100) / 100; 

            document.getElementById('appointment-tax-rate').value = (taxRate * 100).toFixed(2) + '%';
            document.getElementById('appointment-tax-amount').value = taxAmount.toFixed(2);
            document.getElementById('appointment-price').value = totalPrice.toFixed(2);
        }
        

        document.getElementById("editPreviewBtn").onclick = () => {
  document.getElementById("emailPreview").readOnly = false;
  document.getElementById("smsPreview").readOnly = false;
  document.getElementById("savePreviewBtn").style.display = "inline-block";
};



document.addEventListener("DOMContentLoaded", () => {
  // ✅ Now this won't throw if button exists in HTML
  const resetBtn = document.getElementById("resetPreviewBtn");
  if (resetBtn) {
    resetBtn.onclick = async () => {
      if (!currentPreviewAppointment) return;

      const confirmed = confirm("Are you sure you want to reset to the default message?");
      if (!confirmed) return;

      const docRef = doc(db, "appointments", currentPreviewAppointment.id);

      try {
        await updateDoc(docRef, {
          editedEmailBody: "",
          editedSmsBody: ""
        });

        showToast("✏️ Custom message reset to default.");
        closePreviewModal();
      } catch (err) {
        console.error("Reset preview failed:", err);
        showToast("Failed to reset message", "error");
      }
    };
  } else {
    console.warn("⚠️ resetPreviewBtn not found in DOM");
  }
});

// Save button
document.getElementById("savePreviewBtn").onclick = async () => {
  if (!currentPreviewAppointment) return;

  const email = document.getElementById("emailPreview").value.trim();
  const sms = document.getElementById("smsPreview").value.trim();

  const docRef = doc(db, "appointments", currentPreviewAppointment.id);

  try {
    await updateDoc(docRef, {
      editedEmailBody: email,
      editedSmsBody: sms
    });

    showToast("✅ Message saved successfully.");
    closePreviewModal();
  } catch (err) {
    console.error("Save preview failed:", err);
    showToast("Failed to save preview", "error");
  }
};
    // Encrypt sensitive data (e.g., phone number)
        async function encryptData(data) {
        try {
            const encoder = new TextEncoder();
            const dataBuffer = encoder.encode(data);
            const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (error) {
            console.error("Encryption failed:", error);
            return data; // fallback
        }
        }


   // ================ MAIN APPLICATION ================
        function initApp(auth, db, appointmentsCollection, customersCollection) {
            // ================ GLOBAL STATE ================
            let appointments = [];
            let customers = [];
            let editingAppointmentId = null;
            let editingCustomerId = null;
            let chartInstance = null;
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let currentPage = 1;
            const appointmentsPerPage = 10;
            
            // Status map for appointments
            const statusMap = {
                scheduled: { text: "Scheduled", class: "status-scheduled" },
                draft: { text: "Draft", class: "status-draft" },
                released: { text: "Released", class: "status-released" },
                in_progress: { text: "In Progress", class: "status-inprogress" },
                cancelled: { text: "Cancelled", class: "status-cancelled" },
                needs_parts: { text: "Needs Parts", class: "status-warning" },
                parts_ordered: { text: "Parts Ordered", class: "status-inprogress" },
                repair_completed: { text: "Completed", class: "status-released" }
            };
            // ================ VALIDATION UTILITIES ================
    const validators = {
        required: value => value.trim() !== '',
        validDate: value => new Date(value).toString() !== 'Invalid Date',
        validTime: value => /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value),
        validPrice: value => !isNaN(parseFloat(value)) && parseFloat(value) >= 0
    };
 
    function showValidationError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorId = `${fieldId}-error`;
        const errorElement = document.getElementById(errorId);
        
        if (field && errorElement) {
            field.classList.add('invalid');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            errorElement.style.opacity = '1';
        }
    }
    
    function showValidationToast(message, isError = true) {
        const toast = document.createElement("div");
        toast.className = `toast ${isError ? "error" : "success"}`;
        toast.innerHTML = `
            <i class="fas ${isError ? "fa-exclamation-circle" : "fa-check-circle"}"></i>
            <div>${message}</div>
        `;
        document.getElementById("toast-container").appendChild(toast);
        
        // Show toast
        setTimeout(() => toast.classList.add("show"), 100);
        
        // Auto-remove after delay
        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }
    
    function clearValidationError(fieldId) {
        const field = document.getElementById(fieldId);
        const errorId = `${fieldId}-error`;
        const errorElement = document.getElementById(errorId);
        
        if (field) field.classList.remove('invalid');
        if (errorElement) {
            errorElement.style.display = 'none';
            errorElement.textContent = ''; // Clear message text
        }
    }
    
    function clearAllValidationErrors() {
        document.querySelectorAll('.validation-error').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });
        
        document.querySelectorAll('.form-control').forEach(field => {
            field.classList.remove('invalid');
        });
    }
    function initReportsView() {
        const reportsView = document.getElementById('reports-view');
        reportsView.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Reports Dashboard</div>
                </div>
                <div class="card-content">
                    <p>Revenue reports, appointment analytics, and performance metrics coming soon</p>
                    <button class="btn" id="export-reports">
                        <i class="fas fa-file-export"></i> Export Data
                    </button>
                </div>
            </div>
        `;
    }
    
    function initReminderSystem() {
        // Check for appointments needing reminders
        // checkAppointmentReminders();
        
        // Check every hour
        // setInterval(checkAppointmentReminders, 60 * 60 * 1000);
    }
    
    async function checkAppointmentReminders() {
        console.log("🛑 checkAppointmentReminders() is disabled — server handles reminders now.");
}

    function setupFieldValidation(fieldId, validator) {
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        field.addEventListener('blur', () => {
            if (!validator(field.value)) {
                field.classList.add('invalid');
            } else {
                field.classList.remove('invalid');
            }
        });
        
        field.addEventListener('input', () => {
            if (validator(field.value)) {
                field.classList.remove('invalid');
            } else {
                field.classList.add('invalid');
            }
        });
    }
    function initializeValidation() {
          // Define validators
          const validators = {
            required: value => value.trim() !== '',
            validDate: value => !isNaN(Date.parse(value)),
            validTime: value => /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value.trim()),
            validPrice: value => !isNaN(parseFloat(value)) && parseFloat(value) >= 0
        };
        // Customer fields
        setupFieldValidation('customer-name', validators.required, 'Customer name is required');
        setupFieldValidation('appointment-date', validators.validDate, 'Please select a valid date');
        setupFieldValidation('appointment-time', validators.validTime, 'Please select a valid time');
        setupFieldValidation('appointment-price', validators.validPrice, 'Please enter a valid price');
    }
          
    // GoogleMaps 
   
    const baseAddress = "22 Canary Grass Blvd, Hamilton, Ontario, L0R 1P0";
  const apiKey = "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c";


  document.addEventListener("DOMContentLoaded", () => {
  const inputEl = document.getElementById("house-address-input");
  const suggestionsEl = document.getElementById("address-suggestions");

  let debounceTimer;
  inputEl.addEventListener("input", () => {
    clearTimeout(debounceTimer);

    const query = inputEl.value.trim();
    if (query.length < 3) {
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
      return;
    }

    debounceTimer = setTimeout(async () => {
      try {
        const apiKey = "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c"; // your GoMaps API key
        const url = `https://maps.gomaps.pro/maps/api/place/autocomplete/json?input=${encodeURIComponent(query)}&components=country:ca|administrative_area:ON&key=${apiKey}`;


        const response = await fetch(url);
        const data = await response.json();

        if (data.status !== "OK" || !data.predictions.length) {
          suggestionsEl.style.display = "none";
          suggestionsEl.innerHTML = "";
          return;
        }

        suggestionsEl.innerHTML = data.predictions.map(prediction => 
          `<li style="
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
          ">${prediction.description}</li>`
        ).join("");
        suggestionsEl.style.display = "block";

        // Add hover and click handlers
        Array.from(suggestionsEl.children).forEach((li) => {
          li.addEventListener("mouseenter", () => {
            li.style.backgroundColor = "#f0f0f0";
          });
          li.addEventListener("mouseleave", () => {
            li.style.backgroundColor = "transparent";
          });
          li.addEventListener("click", () => {
            inputEl.value = li.textContent;
            suggestionsEl.style.display = "none";
            suggestionsEl.innerHTML = "";
            inputEl.focus();

            // Optional: Trigger validation or route update here
          });
        });

      } catch (err) {
        console.error("Autocomplete error:", err);
        suggestionsEl.style.display = "none";
        suggestionsEl.innerHTML = "";
      }
    }, 300); // debounce delay
  });

  // Optional: close suggestions when clicking outside
  document.addEventListener("click", (e) => {
    if (!suggestionsEl.contains(e.target) && e.target !== inputEl) {
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
    }
  });
});

document.addEventListener("DOMContentLoaded", () => {
  const inputEl = document.getElementById("house-address-input");
  const suggestionsEl = document.getElementById("address-suggestions");
  const apiKey = "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c";

  inputEl.addEventListener("input", async () => {
    const query = inputEl.value.trim();
    if (query.length < 3) {
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
      return;
    }

    try {
        const response = await fetch(`https://maps.gomaps.pro/maps/api/place/autocomplete/json?input=${encodeURIComponent(query)}&components=country:ca&key=${apiKey}`);
      const data = await response.json();

      if (data.status === "OK" && data.predictions.length > 0) {
        suggestionsEl.innerHTML = data.predictions.map(prediction =>
          `<li style="padding: 8px; cursor: pointer;">${prediction.description}</li>`
        ).join("");
        suggestionsEl.style.display = "block";

        Array.from(suggestionsEl.children).forEach((li, index) => {
          li.addEventListener("click", () => {
            inputEl.value = data.predictions[index].description;
            suggestionsEl.style.display = "none";
            suggestionsEl.innerHTML = "";
            inputEl.focus();

            // Optional: call your route update or validation here, e.g.:
            // updateRoute();
          });
        });
      } else {
        suggestionsEl.innerHTML = "<li style='padding: 8px;'>No suggestions found</li>";
        suggestionsEl.style.display = "block";
      }
    } catch (err) {
      console.error("Autocomplete error:", err);
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
    }
  });
});

document.addEventListener("click", (e) => {
  if (!inputEl.contains(e.target) && !suggestionsEl.contains(e.target)) {
    suggestionsEl.style.display = "none";
    suggestionsEl.innerHTML = "";
  }
});

  async function fetchRouteInfo(destination) {
    if (!destination) {
      document.getElementById("gomaps-distance").textContent = "0";
      return;
    }

    const url = `https://maps.gomaps.pro/maps/api/directions/json?origin=${encodeURIComponent(baseAddress)}&destination=${encodeURIComponent(destination)}&units=metric&key=${apiKey}`;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (data.status !== "OK") {
        throw new Error("Directions API error: " + data.status);
      }

      // Sum distance from all legs
      const distanceMeters = data.routes[0].legs.reduce((acc, leg) => acc + leg.distance.value, 0);
      const distanceKm = (distanceMeters / 1000).toFixed(2);

      document.getElementById("gomaps-distance").textContent = distanceKm;
    } catch (error) {
      console.error("Error fetching directions:", error);
      document.getElementById("gomaps-distance").textContent = "N/A";
    }
  }

  // Listen for user input changes (on blur or change)
  const addressInput = document.getElementById("house-address-input");

  addressInput.addEventListener("change", () => {
    const destination = addressInput.value.trim();
    fetchRouteInfo(destination);
  });

  // Optional: also fetch on blur (user leaves input)
  addressInput.addEventListener("blur", () => {
    const destination = addressInput.value.trim();
    fetchRouteInfo(destination);
  });
  async function validateAddress(address) {
  if (!address) return false;

  const apiKey = "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c";
  const url = `https://maps.gomaps.pro/maps/api/geocode/json?address=${encodeURIComponent(address + ', Ontario, Canada')}&region=ca&key=${apiKey}`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.status === "OK" && data.results.length > 0) {
      // Optionally, you can check result types or components here
      return true;  // Valid address
    } else {
      return false; // Invalid address
    }
  } catch (error) {
    console.error("Validation error:", error);
    return false;
  }
}
async function formatAddress(rawAddress) {
  const apiKey = "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c";
  const url = `https://maps.gomaps.pro/maps/api/geocode/json?address=${encodeURIComponent(rawAddress)}&key=${apiKey}`;
  
  const response = await fetch(url);
  const data = await response.json();

  if (data.status === "OK" && data.results.length > 0) {
    // Use the first formatted address
    return data.results[0].formatted_address;
  }
  return null; // no valid address found
}
async function getAddressSuggestions(query) {
  const apiKey = "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c";
  const url = `https://maps.gomaps.pro/maps/api/place/autocomplete/json?input=${encodeURIComponent(query)}&components=country:ca|administrative_area:ON&key=${apiKey}`;
  
  const response = await fetch(url);
  const data = await response.json();

  if (data.status === "OK") {
    return data.predictions; // array of suggested places
  }
  return [];
}

// Show suggestions in a dropdown under input
const inputEl = document.getElementById("house-address-input");
const suggestionsEl = document.createElement("ul");
suggestionsEl.style.position = "absolute";
suggestionsEl.style.background = "white";
suggestionsEl.style.border = "1px solid #ccc";
suggestionsEl.style.zIndex = "1000";
inputEl.parentNode.appendChild(suggestionsEl);

inputEl.addEventListener("input", async () => {
  const query = inputEl.value;
  if (query.length < 3) {
    suggestionsEl.innerHTML = "";
    return;
  }
  const suggestions = await getAddressSuggestions(query);
  
  if (suggestions.length === 0) {
    suggestionsEl.innerHTML = "<li>No suggestions found</li>";
    return;
  }
  
  suggestionsEl.innerHTML = suggestions.map(s => `<li style="padding:5px; cursor:pointer;">${s.description}</li>`).join("");
  
  // Add click handler on suggestions
  Array.from(suggestionsEl.children).forEach((li, idx) => {
    li.onclick = () => {
      inputEl.value = suggestions[idx].description;
      suggestionsEl.innerHTML = "";
      inputEl.focus();
    };
  });
});

// When input loses focus or selection made:
document.getElementById("house-address-input").addEventListener("blur", async () => {
  const input = document.getElementById("house-address-input");
  const formatted = await formatAddress(input.value);
  if (formatted) {
    input.value = formatted;
  }
});

// Use this on input blur or form submit
document.getElementById("house-address-input").addEventListener("blur", async function () {
  const errorDiv = document.getElementById("house-address-error");
  const isValid = await validateAddress(this.value);
  if (!isValid) {
    errorDiv.textContent = "Please enter a valid address.";
  } else {
    errorDiv.textContent = "";
  }
});

document.addEventListener("DOMContentLoaded", function () {
  const apiKey = document.getElementById("gomaps-widget").dataset.apiKey;
  const originAddress = document.getElementById("gomaps-widget").dataset.distanceFrom;
  const houseInput = document.getElementById("house-address-input");
  const distanceDisplay = document.getElementById("gomaps-distance");

  async function fetchDirections(destination) {
    const url = `https://maps.gomaps.pro/maps/api/directions/json?origin=${encodeURIComponent(originAddress)}&destination=${encodeURIComponent(destination)}&units=metric&key=${apiKey}`;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (data.status === "OK" && data.routes && data.routes.length > 0) {
        const route = data.routes[0];
        // Calculate total distance from all legs (in meters)
        const totalMeters = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
        const distanceKm = (totalMeters / 1000).toFixed(2);
        distanceDisplay.textContent = distanceKm;

        // Now update the map using GoMaps Pro's own JS render method
        // (assuming gomaps pro exposes a method to draw routes on the widget container)
        // This part depends on their SDK, so if you have their JS SDK or docs,
        // you might do something like:
        //
        // GoMapsPro.renderRoute('gomaps-widget', route);
        //
        // But if not exposed, their widget may automatically handle it after setting the input.
      } else {
        distanceDisplay.textContent = "N/A";
        console.warn("No routes found or error:", data.status);
      }
    } catch (err) {
      console.error("Directions fetch error:", err);
      distanceDisplay.textContent = "N/A";
    }
  }

  // Trigger directions fetch when user finishes typing or leaves the input
  houseInput.addEventListener("change", () => {
    const destination = houseInput.value.trim();
    if (destination.length > 0) {
      fetchDirections(destination);
    } else {
      distanceDisplay.textContent = "0";
    }
  });
});

document.addEventListener("DOMContentLoaded", () => {
  const baseAddress = "22 Canary Grass Blvd, Hamilton, Ontario, L0R 1P0";
  const apiKey = "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c";

  const inputEl = document.getElementById("house-address-input");
  const suggestionsEl = document.getElementById("address-suggestions");
  const errorDiv = document.getElementById("house-address-error");
  const distanceDisplay = document.getElementById("gomaps-distance");

  let debounceTimer;

  // Debounced autocomplete
  inputEl.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    const query = inputEl.value.trim();

    if (query.length < 3) {
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
      return;
    }

    debounceTimer = setTimeout(async () => {
      try {
        // Add Ontario + Canada restriction in components param
        const url = `https://maps.gomaps.pro/maps/api/place/autocomplete/json?input=${encodeURIComponent(query)}&components=country:ca|administrative_area:ON&key=${apiKey}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status !== "OK" || !data.predictions.length) {
          suggestionsEl.style.display = "none";
          suggestionsEl.innerHTML = "";
          return;
        }

        suggestionsEl.innerHTML = data.predictions.map(prediction => 
          `<li style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;">${prediction.description}</li>`
        ).join("");
        suggestionsEl.style.display = "block";

        Array.from(suggestionsEl.children).forEach((li, index) => {
          li.addEventListener("mouseenter", () => li.style.backgroundColor = "#f0f0f0");
          li.addEventListener("mouseleave", () => li.style.backgroundColor = "transparent");
          li.addEventListener("click", () => {
            inputEl.value = data.predictions[index].description;
            suggestionsEl.style.display = "none";
            suggestionsEl.innerHTML = "";
            inputEl.focus();
            errorDiv.textContent = "";

            fetchRouteInfo(inputEl.value);
          });
        });
      } catch (err) {
        console.error("Autocomplete error:", err);
        suggestionsEl.style.display = "none";
        suggestionsEl.innerHTML = "";
      }
    }, 300);
  });

  // Hide suggestions if click outside
  document.addEventListener("click", e => {
    if (!suggestionsEl.contains(e.target) && e.target !== inputEl) {
      suggestionsEl.style.display = "none";
      suggestionsEl.innerHTML = "";
    }
  });

  // Validate and format on blur
  inputEl.addEventListener("blur", async () => {
    const rawAddress = inputEl.value.trim();
    if (!rawAddress) return;

    const formatted = await formatAddress(rawAddress);
    if (formatted) inputEl.value = formatted;

    const isValid = await validateAddress(inputEl.value);
    if (!isValid) {
      errorDiv.textContent = "Please enter a valid address.";
    } else {
      errorDiv.textContent = "";
      fetchRouteInfo(inputEl.value);
    }
  });

  // Fetch route info when input changes (change event)
  inputEl.addEventListener("change", () => {
    const destination = inputEl.value.trim();
    if (destination.length > 0) fetchRouteInfo(destination);
    else distanceDisplay.textContent = "0";
  });

  async function fetchRouteInfo(destination) {
    if (!destination) {
      distanceDisplay.textContent = "0";
      return;
    }

    const url = `https://maps.gomaps.pro/maps/api/directions/json?origin=${encodeURIComponent(baseAddress)}&destination=${encodeURIComponent(destination)}&units=metric&key=${apiKey}`;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (data.status !== "OK") throw new Error("Directions API error: " + data.status);

      const distanceMeters = data.routes[0].legs.reduce((acc, leg) => acc + leg.distance.value, 0);
      distanceDisplay.textContent = (distanceMeters / 1000).toFixed(2);
    } catch (err) {
      console.error("Error fetching directions:", err);
      distanceDisplay.textContent = "N/A";
    }
  }

  async function validateAddress(address) {
    if (!address) return false;

    const url = `https://maps.gomaps.pro/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      return data.status === "OK" && data.results.length > 0;
    } catch {
      return false;
    }
  }

  async function formatAddress(rawAddress) {
    if (!rawAddress) return null;

    const url = `https://maps.gomaps.pro/maps/api/geocode/json?address=${encodeURIComponent(rawAddress)}&key=${apiKey}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      if (data.status === "OK" && data.results.length > 0) return data.results[0].formatted_address;
      return null;
    } catch {
      return null;
    }
  }
});

    
    // ================ VIEW MANAGEMENT ================
            function activateView(viewName) {
        // Remove active class from ALL sidebar links first
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.classList.remove('active');
        });
        
        // Add active class ONLY to the current view
        const currentLink = document.querySelector(`.nav-links a[data-view="${viewName}"]`);
        if (currentLink) {
            currentLink.classList.add('active');
        }
        
        // Hide all views
        document.querySelectorAll('.tab-content').forEach(view => {
            view.classList.remove('active');
        });
        
        // Show requested view
        const viewElement = document.getElementById(`${viewName}-view`);
        if (viewElement) viewElement.classList.add('active');
        
        // Initialize view-specific content
        switch(viewName) {
            case "dashboard":
            initReminderSystem();
                updateStats();
                initChart();
                renderAppointmentsChart();
                break;
            case "appointments":
                fetchAppointments();
                break;
            case "calendar":
                renderCalendar();
                updateCalendarSummary();
                setupCalendarEventHandlers();
                break;
            case "customers":
                fetchCustomers();
                break;
            case "reports":
                initReportsView();
                break;
            case "logs":
            fetchLogs();
            break;
            case "settings":
                loadSettings();
                break;
            case "help":
                initHelpView();
                break;
        }
        
        // Auto-close sidebar on mobile
        if (window.innerWidth <= 576) {
            document.querySelector('.sidebar').classList.remove('active');
        }
    }           
            // ================ AUTHENTICATION HANDLING ================
            onAuthStateChanged(auth, (user) => {
              if (!user){
                window.location.href = "admin-login.html";
                } else {
                    // Show logged-in user's email
                    document.getElementById("user-name").textContent = user.email;
                    fetchAppointments();
                }
            });
            
            // Logout function
            function logout() {
                if (confirm("Are you sure you want to logout?")) {
                    signOut(auth)
                        .then(() => {
                            window.location.href = "admin-login.html";
                        })
                        .catch((error) => {
                            console.error("Logout error:", error);
                            showToast("Logout failed", true);
                        });
                }
            }
            // Helper function for search
function appointmentMatchesSearch(appointment, query) {
    return (
        appointment.customer?.toLowerCase().includes(query) ||
        appointment.phone?.includes(query) ||
        appointment.email?.toLowerCase().includes(query) ||
        appointment.houseAddress?.toLowerCase().includes(query)
    );
}
            // ================ DATA MANAGEMENT ================
            // Fetch appointments from Firestore
            async function fetchAppointmentsWithCache() {
                const now = Date.now();
                if (cachedAppointments && now - lastFetchTime < CACHE_DURATION) {
                    return cachedAppointments;
                }
                
                showLoading(true);
                // Show skeleton loader while data is loading
                showSkeletonLoader('appointments-body', 7);
                
                try {
                    // Create optimized query with ordering and limit
                    const q = query(
                        appointmentsCollection,
                        orderBy("date", "desc"),
                        limit(100) // Get only the most recent 100 appointments
                    );
                    
                    const snapshot = await getDocs(q);
                    
                    cachedAppointments = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            dateObj: data.date ? data.date.toDate() : new Date()
                        };
                    });
                    
                    lastFetchTime = now;
                    return cachedAppointments;
                } catch (error) {
                    console.error("Error fetching appointments:", error);
                    showToast("Failed to fetch appointments", true);
                    return [];
                } finally {
                    showLoading(false);
                }
            }
    
async function fetchAppointments() {
    try {
        const allAppointments = await fetchAppointmentsWithCache(); // Get all appointments (cached or fresh)
        
        // Check if the data is valid
        if (!Array.isArray(allAppointments)) {
            throw new Error("Fetched data is not an array.");
        }
     // Debug: log the statusFilter and appointment statuses
        console.log("Current statusFilter:", statusFilter);
        console.log("Appointments status before filter:", allAppointments.map(app => app.status)); // Logs all statuses
        // Apply status filter (if 'All' is selected, return all appointments)
        const allowedStatuses = statusGroups[statusFilter];

        const filteredAppointments = !allowedStatuses
        ? allAppointments
        : allAppointments.filter(app => allowedStatuses.includes(app.status));


        // Debugging: Log the filtered appointments
        console.log("Filtered Appointments:", filteredAppointments);

        // Handle reminders (if applicable)
        if (auth?.currentUser && !sessionStorage.getItem(`reminderShown_${auth.currentUser.uid}`)) {
            const tomorrowReminders = filteredAppointments.filter(app =>
                app.reminderEnabled && app.dateObj && isTomorrow(app.dateObj)
            );

            if (tomorrowReminders.length > 0) {
                showToast(`📅 Reminder: You have ${tomorrowReminders.length} appointment(s) for tomorrow.`);
                sessionStorage.setItem(`reminderShown_${auth.currentUser.uid}`, "true");
            }
        }

        // Render the filtered appointments (use the filtered data)
       renderAppointmentsTable(filteredAppointments);
        updateStats();

        // Call chart and other necessary initializations
        setTimeout(() => {
            if (document.getElementById('calendar-view').classList.contains('active')) {
                renderCalendar();
                updateCalendarSummary();
            }
            if (document.getElementById('dashboard-view').classList.contains('active')) {
                initChart();
            }
        }, 50);

        setupRealtimeListeners();
    } catch (error) {
        console.error("Error in fetchAppointments:", error);
        showToast("Failed to load appointments", true);
    }
}


function renderAppointmentsChart() {
    // Get appointments for current month
    const monthlyApps = appointments.filter(app => {
        const appDate = app.dateObj;
        return appDate.getMonth() === currentMonth && 
               appDate.getFullYear() === currentYear;
    });

    // Count appointments per day
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const dayCounts = new Array(daysInMonth).fill(0);

    monthlyApps.forEach(app => {
        const day = app.dateObj.getDate();
        dayCounts[day - 1] += 1;
    });

    const labels = Array.from({ length: daysInMonth }, (_, i) => `Day ${i + 1}`);

    const ctx = document.getElementById('appointmentsChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Appointments',
                data: dayCounts,
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Appointments This Month'
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
}


          
            function setupRealtimeListeners() {
  const appointmentsQuery = query(appointmentsCollection, orderBy("date", "desc"));
  
  onSnapshot(appointmentsQuery, (snapshot) => {
    appointments = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      dateObj: doc.data().date.toDate()
    }));
    renderAppointmentsTable();
    updateStats();
    if (document.getElementById('calendar-view').classList.contains('active')) {
      renderCalendar();
    }
  });
}
async function fetchLogs() {
  const logsBody = document.getElementById("logs-body");
  logsBody.innerHTML = `<tr><td colspan="7" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading logs...</td></tr>`;

  try {
    const logsQuery = query(collection(db, "logs"), orderBy("timestamp", "desc"));
    const snapshot = await getDocs(logsQuery);
    const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // Step 1: Collect unique appointment IDs
    const appointmentIds = [...new Set(logs.map(log => log.appointmentId).filter(Boolean))];

    // Step 2: Fetch appointments in parallel
    const appointmentMap = {};
    const fetchPromises = appointmentIds.map(async (id) => {
      try {
        const apptSnap = await getDoc(doc(db, "appointments", id));
        if (apptSnap.exists()) {
          appointmentMap[id] = apptSnap.data();
        }
      } catch (err) {
        console.warn(`❌ Failed to fetch appointment ${id}:`, err.message);
      }
    });
    await Promise.all(fetchPromises);

    // Step 3: Render table
    const rows = logs.map(log => {
      const time = log.timestamp?.toDate?.().toLocaleString() || "N/A";
      const appt = appointmentMap[log.appointmentId];
      const customerName = appt?.customer || "N/A";

      return `
        <tr>
          <td>${log.type}</td>
          <td>${customerName}</td>
          <td>${log.emailSent ? "✅" : "❌"}</td>
          <td>${log.smsSent ? "✅" : "❌"}</td>
          <td>${log.status || "-"}</td>
          <td>${time}</td>
          <td>${log.smsError || "-"}</td>
        </tr>
      `;
    });

    logsBody.innerHTML = rows.length > 0 ? rows.join("") : `
      <tr><td colspan="7" style="text-align:center;">No logs found.</td></tr>`;
  } catch (error) {
    console.error("Failed to fetch logs:", error);
    logsBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Failed to load logs</td></tr>`;
  }
}
function logErrorToServer(error) {
        // Send error to backend for logging
        fetch('/api/log-error', {
            method: 'POST',
            body: JSON.stringify({
                message: error.message,
                stack: error.stack,
                timestamp: new Date().toISOString()
            })
        });
    }
            // Fetch customers from Firestore
            async function fetchCustomers() {
                showLoading(true);
                try {
                    const snapshot = await getDocs(customersCollection);
                    customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCustomersTable();
                } catch (error) {
                    console.error("Error fetching customers:", error);
                    showToast("Failed to load customers", true);
                } finally {
                    showLoading(false);
                }
            }
            
            function initReportsCharts() {
        // Repair Time Chart
        const repairTimeCtx = document.getElementById('repairTimeChart').getContext('2d');
        new Chart(repairTimeCtx, {
            type: 'bar',
            data: {
                labels: ['Treadmills', 'Ellipticals', 'Bikes', 'Rowers', 'Strength'],
                datasets: [{
                    label: 'Avg. Repair Time (hours)',
                    data: [3.2, 2.8, 1.5, 2.1, 4.2],
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Hours'
                        }
                    }
                }
            }
        });
    
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'doughnut',
            data: {
                labels: ['Treadmills', 'Ellipticals', 'Bikes', 'Rowers', 'Strength'],
                datasets: [{
                    label: 'Revenue by Type',
                    data: [1850, 1200, 650, 430, 150],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
function formatDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Add leading zero if necessary
    const day = date.getDate().toString().padStart(2, '0'); // Add leading zero if necessary
    return `${year}-${month}-${day}`;
}
    // ===== SETTINGS VIEW INITIALIZATION =====
    function updateNotificationStatusIndicators() {
        const emailEnabled = document.getElementById('email-notifications').checked;
        const smsEnabled = document.getElementById('sms-notifications').checked;
        
        const emailStatus = document.getElementById('email-notification-status');
        const smsStatus = document.getElementById('sms-notification-status');
        
        emailStatus.className = 'notification-status ' + (emailEnabled ? 'enabled' : '');
        smsStatus.className = 'notification-status ' + (smsEnabled ? 'enabled' : '');
    }
    
    async function loadSettings() {
        // Show loading state
        const btn = document.getElementById('save-settings');
        const originalHTML = btn ? btn.innerHTML : '';
        
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading settings...';
            btn.disabled = true;
        }
    
        try {
            // Clear any previous validation errors
            clearAllValidationErrors();
            
            // Check if user is authenticated
            const user = auth.currentUser;
            let settings = null;
            
            // 1. Try loading from Firestore
            if (user) {
                try {
                    const settingsRef = doc(db, "settings", user.uid);
                    const docSnap = await getDoc(settingsRef);
                    
                    if (docSnap.exists()) {
                        settings = docSnap.data();
                        console.log("Settings loaded from Firestore:", settings);
                        // Store in localStorage for faster access
                        localStorage.setItem('fitnessRepairSettings', JSON.stringify(settings));
                    }
                } catch (firestoreError) {
                    console.warn("Firestore load failed, falling back to localStorage:", firestoreError);
                }
            }
            
            // 2. If not found in Firestore, try localStorage
            if (!settings) {
                const localData = localStorage.getItem('fitnessRepairSettings');
                if (localData) {
                    settings = JSON.parse(localData);
                    console.log("Settings loaded from localStorage:", settings);
                }
            }
            
            // 3. Apply settings to form or use defaults
            if (settings) {
                window.fitnessRepairSettings = settings;
                document.getElementById('settings-full-name').value = settings.fullName || "Admin User";
                document.getElementById('settings-business-name').value = settings.businessName || "Canadian Fitness Repair";
                document.getElementById('settings-start-time').value = settings.startTime || "08:00";
                document.getElementById('settings-end-time').value = settings.endTime || "18:00";
                document.getElementById('email-notifications').checked = settings.emailNotifications !== false; // default true
                document.getElementById('sms-notifications').checked = !!settings.smsNotifications;
                document.getElementById('admin-phone').value = settings.adminPhone || "";
                document.getElementById('sms-carrier').value = settings.smsCarrier || "";
                if (settings.province) {
                    document.getElementById('business-province').value = settings.province;
                }
                if (settings.timeZone) {
                    document.getElementById('timezone').value = settings.timeZone;
                } else {
                    // Set default based on user's location
                    const defaultTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    document.getElementById('timezone').value = 
                        defaultTZ.startsWith('America') ? defaultTZ : 'America/Toronto';
                }
                // Update business name in UI
                if (settings.businessName) {
                    document.querySelector('.brand h2').textContent = settings.businessName;
                }
            } else {
                // Set default values if no settings found
                document.getElementById('settings-full-name').value = "Admin User";
                document.getElementById('settings-business-name').value = "Canadian Fitness Repair";
                document.getElementById('settings-start-time').value = "08:00";
                document.getElementById('settings-end-time').value = "18:00";
                document.getElementById('email-notifications').checked = true;
                document.getElementById('sms-notifications').checked = false;
                document.getElementById('admin-phone').value = "";
                document.getElementById('sms-carrier').value = "";
            }
            
            // Update notification indicators
            updateNotificationStatusIndicators();
            
            // Show success message
            showToast("Settings loaded successfully");
            
        } catch (error) {
            console.error("Error loading settings:", error);
            showToast("Failed to load settings", true);
        } finally {
            // Restore button state
            if (btn) {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
                btn.disabled = false;
            }
        }
    }
    
    async function saveSettings() {
        const btn = document.getElementById('save-settings');
        if (!btn) return;
        
        const originalHTML = btn.innerHTML;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;
        
        try {
            // Authentication State Check
            const user = auth.currentUser;
            if (!user) {
                showToast("You need to be logged in to save settings", true);
                return;
            }
            
            // Get form values
            const fullName = document.getElementById('settings-full-name').value.trim();
            const businessName = document.getElementById('settings-business-name').value.trim();
            const startTime = document.getElementById('settings-start-time').value;
            const endTime = document.getElementById('settings-end-time').value;
            const emailNotifications = document.getElementById('email-notifications').checked;
            const smsNotifications = document.getElementById('sms-notifications').checked;
            const adminPhone = document.getElementById('admin-phone').value.trim();
            const smsCarrier = document.getElementById('sms-carrier').value;
            const province = document.getElementById('business-province').value;
            const timeZone = document.getElementById('timezone').value;
            
            
            // Clear previous errors
            clearAllValidationErrors();
            
            // Validate inputs
            let isValid = true;
            
            if (!fullName) {
                showValidationError('settings-full-name', 'Full name is required');
                isValid = false;
            }
            
            if (!businessName) {
                showValidationError('settings-business-name', 'Business name is required');
                isValid = false;
            }
            
            // CANADIAN PHONE VALIDATION (supports 10-digit format)
            if (adminPhone) {
                const cleanPhone = adminPhone.replace(/\D/g, '');
                // Validates 10-digit Canadian numbers (without country code)
                if (cleanPhone.length !== 10) {
                    showValidationError('admin-phone', 'Canadian phone must be 10 digits (e.g., 4165551234)');
                    isValid = false;
                }
            } else if (smsNotifications) {
                showValidationError('admin-phone', 'Phone number is required for SMS notifications');
                isValid = false;
            }
            
            // CANADIAN CARRIER VALIDATION
            const canadianCarriers = ['rogers', 'fido', 'bell', 'telus', 'koodo', 'virgin', 'freedom', 'chatr', 'public'];
            if (smsNotifications) {
                if (!smsCarrier) {
                    showToast("Please select a mobile carrier for SMS notifications", true);
                    isValid = false;
                } else if (!canadianCarriers.includes(smsCarrier)) {
                    showToast("Selected carrier is not supported in Canada", true);
                    isValid = false;
                }
            }
    
            if (!startTime || !endTime) {
                showToast("Business hours are required", true);
                isValid = false;
            } else if (startTime >= endTime) {
                showToast("Closing time must be after opening time", true);
                isValid = false;
            }
            
            if (!isValid) {
                showToast("Please fix validation errors", true);
                return;
            }
            
            // Prepare settings data
            const settings = {
                fullName,
                businessName,
                startTime,
                endTime,
                emailNotifications,
                smsNotifications,
                province,
                timeZone,
                // Store cleaned Canadian phone number
                adminPhone: adminPhone.replace(/\D/g, ''),
                smsCarrier,
                lastUpdated: new Date().toISOString(),
                country: "CA" // Add country identifier
            };
            
            // Store in localStorage
            localStorage.setItem('fitnessRepairSettings', JSON.stringify(settings));
            
            // Save to Firestore
            try {
                const settingsRef = doc(db, "settings", user.uid);
                await setDoc(settingsRef, settings, { merge: true });
            } catch (firestoreError) {
                console.error("Firestore save error:", firestoreError);
                // Special handling for Canadian users
                if (firestoreError.code === 'permission-denied') {
                    showToast("Permission error. Please contact support.", true);
                } else {
                    showToast(`Failed to save settings: ${firestoreError.message}`, true);
                }
                return;
            }
            
            // Update UI
            document.querySelector('.brand h2').textContent = businessName;
            showToast("Settings saved successfully!");
            updateNotificationStatusIndicators();
            
        } catch (error) {
            console.error("Error saving settings:", error);
            showToast(`Failed to save settings: ${error.message}`, true);
        } finally {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }
    function checkAndShowReminder(appointments) {
  const today = new Date();
  const todayStr = today.toLocaleDateString('en-CA');
  
  // Create a unique key for today's reminder check
  const reminderKey = `reminderShown_${todayStr}`;
  
  // Only run once per day per tab session
  if (sessionStorage.getItem(reminderKey)) return;

  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  const tomorrowStr = tomorrow.toLocaleDateString('en-CA');

  const hasReminder = appointments.some(app => {
    const dateStr = app.dateObj?.toLocaleDateString('en-CA');
    return dateStr === tomorrowStr && app.reminderEnabled;
  });

  if (hasReminder) {
    showToast("📅 Reminder: You have appointments scheduled for tomorrow.");
    // Set session storage with date-specific key
    sessionStorage.setItem(reminderKey, 'true');
  }
}
    async function fetchLogs() {
  const logsBody = document.getElementById("logs-body");
  logsBody.innerHTML = `<tr><td colspan="7" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading logs...</td></tr>`;

  try {
    const logsQuery = query(collection(db, "logs"), orderBy("timestamp", "desc"));
    const snapshot = await getDocs(logsQuery);
    allLogs = [];

    for (const logDoc of snapshot.docs) {
      const log = logDoc.data();
      const time = log.timestamp?.toDate?.().toLocaleString() || "N/A";
      let customerName = "N/A";

      if (log.appointmentId) {
        try {
          const apptSnap = await getDoc(doc(db, "appointments", log.appointmentId));
          if (apptSnap.exists()) {
            customerName = apptSnap.data().customer || "Unknown";
          }
        } catch (err) {
          console.warn("Error fetching appointment:", err.message);
        }
      }

      allLogs.push({
        ...log,
        customer: customerName,
        timeStr: time
      });
    }

    renderLogsPage(); // Render page 1
  } catch (error) {
    console.error("Failed to fetch logs:", error);
    logsBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Failed to load logs</td></tr>`;
  }
}
        function renderLogsPage() {
            const logsBody = document.getElementById("logs-body");
            const start = (currentLogPage - 1) * logsPerPage;
            const pageLogs = allLogs.slice(start, start + logsPerPage);

            const rows = pageLogs.map(log => `
                <tr>
                <td>${log.type}</td>
                <td>${log.customer || "N/A"}</td>
                <td>${log.emailSent ? "✅" : "❌"}</td>
                <td>${log.smsSent ? "✅" : "❌"}</td>
                <td>${log.status || "-"}</td>
                <td>${log.timeStr || "-"}</td>
                <td>${log.smsError || "-"}</td>
                </tr>
            `);

            logsBody.innerHTML = rows.length > 0
                ? rows.join("")
                : `<tr><td colspan="7" style="text-align:center;">No logs found.</td></tr>`;

            // Update pagination UI
            const totalPages = Math.ceil(allLogs.length / logsPerPage);
            document.getElementById("log-page-indicator").textContent = `Page ${currentLogPage} of ${totalPages}`;
            document.getElementById("prev-log-page").disabled = currentLogPage === 1;
            document.getElementById("next-log-page").disabled = currentLogPage >= totalPages;
            }

    function checkAndShowReminder(appointments) {
  // 🔁 Only run once per tab session
  if (sessionStorage.getItem('reminderShown') === 'true') return;

  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toLocaleDateString('en-CA');

  const hasReminder = appointments.some(app => {
    const dateStr = app.dateObj?.toLocaleDateString('en-CA');
    return dateStr === tomorrowStr && app.reminderEnabled;
  });

  if (hasReminder) {
    showToast("📅 Reminder: You have appointments scheduled for tomorrow.");
    sessionStorage.setItem('reminderShown', 'true');
  }
}

    // Email notification service
    async function sendEmailNotification(eventType, appointment) {
        let subject, body;
        
        switch(eventType) {
            case 'appointment_created':
                subject = "New Appointment Created";
                body = `You have a new appointment with ${appointment.customer} on ${appointment.dateObj.toLocaleDateString()}`;
                break;
            case 'appointment_updated':
                subject = "Appointment Updated";
                body = `Appointment with ${appointment.customer} has been updated`;
                break;
            case 'appointment_reminder':
                subject = "Appointment Reminder";
                body = `Reminder: You have an appointment with ${appointment.customer} tomorrow`;
                break;
        }
        
        try {
            await fetch('https://cfr-backend-1.onrender.com/api/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            recipient: "canadianfitnessrepair@gmail.com",
            subject,
            body
        })
    });
} catch (error) {
    console.error('Email sending failed:', error);
}

    }
    
    // SMS notification service
    async function sendSMSNotification(eventType, appointment) {
        try {
            // Get admin notification settings
            const settings = JSON.parse(localStorage.getItem('fitnessRepairSettings') || '{}');
            
            // Check if SMS notifications are enabled
            if (eventType !== 'test' && !settings.smsNotifications) {
                console.log("SMS notifications are disabled");
                return false;
            }
            
            // Ensure we have required information
            if (!settings.adminPhone || !settings.smsCarrier) {
                const errorMsg = "Missing admin phone or carrier information";
                if (eventType === 'test') {
                    showToast("Cannot send SMS: " + errorMsg, true);
                }
                console.error(errorMsg);
                return false;
            }
    
            // Format message based on event type
            let message;
            switch(eventType) {
                case 'appointment_created':
                    message = `📅 New appt: ${appointment.customer} on ${appointment.dateObj.toLocaleDateString('en-CA')} at ${appointment.dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    break;
                case 'appointment_updated':
                    message = `🔄 Updated: ${appointment.customer}'s appt on ${appointment.dateObj.toLocaleDateString('en-CA')}`;
                    break;
                case 'appointment_reminder':
                    message = `⏰ Reminder: Appt with ${appointment.customer} tomorrow at ${appointment.dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    break;
                case 'test':
                    message = "✅ Test: Canadian Fitness Repair notifications are working!";
                    break;   
                default:
                    message = `ℹ️ Appointment update: ${appointment.customer}`;
            }
            
            // Truncate message to SMS length limit
            const smsMessage = message.substring(0, 160);
            
            // Show sending notification for test SMS
            if (eventType === 'test') {
                showToast("Sending test SMS...");
            }
    
            // CANADIAN CARRIER GATEWAYS
            const canadianCarrierGateways = {
                rogers: "pcs.rogers.com",
                fido: "fido.ca",
                bell: "txt.bell.ca",
                telus: "msg.telus.com",
                koodo: "msg.koodomobile.com",
                virgin: "vmobile.ca",
                freedom: "txt.freedommobile.ca",
                chatr: "pcs.rogers.com",  // Same as Rogers
                public: "msg.telus.com"   // Same as Telus
            };
    
            // Get domain for selected carrier
            const domain = canadianCarrierGateways[settings.smsCarrier];
            if (!domain) {
                const errorMsg = `Unsupported Canadian carrier: ${settings.smsCarrier}`;
                if (eventType === 'test') {
                    showToast(errorMsg, true);
                }
                console.error(errorMsg);
                return false;
            }
    
            // Format phone number for Canadian SMS gateway (1 + 10-digit number)
            const cleanPhone = settings.adminPhone.replace(/\D/g, '');
            if (cleanPhone.length !== 10) {
                const errorMsg = "Canadian phone must be 10 digits";
                if (eventType === 'test') {
                    showToast(errorMsg, true);
                }
                console.error(errorMsg);
                return false;
            }
    
            // Create email address for SMS gateway (1 + 10 digits)
            const smsEmail = `1${cleanPhone}@${domain}`;
    
            // Send via email-to-SMS gateway
            const response = await fetch('https://cfr-backend-1.onrender.com/api/send-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
        recipient: smsEmail,
        subject: "CFR Notification",
        body: smsMessage
    })
});
         
            const result = await response.json();
            
            if (response.ok && result.success) {
                console.log(`[📱 SMS SENT] ${eventType} to 1${cleanPhone} via ${settings.smsCarrier}`);
                
                if (eventType === 'test') {
                    showToast("Test SMS sent successfully! Check your phone.");
                }
                return true;
            } else {
                const errorMsg = result.error || "Unknown error";
                console.error('SMS sending failed:', errorMsg);
                
                if (eventType === 'test') {
                    showToast(`Failed to send SMS: ${errorMsg}`, true);
                }
                return false;
            }
        } catch (error) {
            console.error('Error sending SMS:', error);
            
            if (eventType === 'test') {
                showToast(`SMS failed: ${error.message}`, true);
            }
            return false;
        }
    }
    // Run this check periodically (e.g., every hour)
    // setInterval(checkUpcomingAppointments, 60 * 60 * 1000);
    // ===== HELP VIEW INITIALIZATION =====
    function initHelpView() {
        // This could fetch FAQs from your backend
        // For now, we'll just initialize the support form
        document.getElementById('support-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const subject = document.getElementById('support-subject').value;
            const message = document.getElementById('support-message').value;
            
            if (!subject || !message) {
                showToast("Please fill all fields", true);
                return;
            }
            
            // Simulate sending support request
            showLoading(true);
            setTimeout(() => {
                showLoading(false);
                showToast("Your support request has been submitted!");
                document.getElementById('support-form').reset();
            }, 1500);
        });
    }
         // Notification trigger function
         function triggerNotifications(eventType, appointmentData) {
        console.log("🔥 triggerNotifications() started");
    console.log("📨 Sending notification type:", eventType, appointmentData);

    // Get current settings
    const settings = JSON.parse(localStorage.getItem('fitnessRepairSettings') || '{}');


    if (settings.emailNotifications) {
        sendEmailNotification(eventType, appointmentData);
    }

    if (settings.smsNotifications) {
        sendSMSNotification(eventType, appointmentData);
    }
}

document.getElementById("close-preview-icon").addEventListener("click", closePreviewModal);
document.getElementById("close-preview-btn").addEventListener("click", closePreviewModal);


function resetForm() {
    // Reset the form fields
    document.getElementById('customer-form').reset();
    
    // Clear all error messages
    document.querySelectorAll('.error-message').forEach(msg => msg.innerText = '');
    
    // Reset modal title to "Add New Customer"
    document.getElementById('customer-modal-title').textContent = "Add New Customer";
    
    // Reset editingCustomerId to null, as it's no longer editing
    editingCustomerId = null;

    // Optionally, you can close the modal
    document.getElementById('customer-modal').classList.remove('active');
}

// Validation functions
function isValidPhone(phone) {
    // This regex allows numbers with or without dashes.
    const phonePattern = /^(\d{3}[-\s]?)?(\d{3}[-\s]?)?(\d{4})$/;
    return phonePattern.test(phone);
}

function isValidEmail(email) {
    // Simple email validation pattern (can be more complex if needed)
   const emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
}

async function saveCustomer() {
    const name = document.getElementById('customer-modal-name').value.trim();
    const phone = document.getElementById('customer-modal-phone').value.trim();
    const email = document.getElementById('customer-modal-email').value.trim();
    const address = document.getElementById('customer-modal-address').value.trim();
    const notes = document.getElementById('customer-modal-notes').value.trim();
    const equipment = document.getElementById('customer-modal-equipment').value.trim(); // New field for equipment
    const lastAppointment = document.getElementById('customer-modal-last-appointment').value.trim(); // New field for last appointment
    // Reset all previous error messages
    document.querySelectorAll('.error-message').forEach(msg => msg.innerText = '');
    
    // ✅ Validate required fields
    let isValid = true; // Flag to track validity

    // Validate name
    if (!name) {
        document.getElementById('name-error').innerText = "Full name is required";
        isValid = false;
    }

    // Ensure that either phone or email is provided
    if (!phone && !email) {
        document.getElementById('phone-error').innerText = "Either phone or email is required";
        isValid = false;
    }

    // Validate phone number if provided
    if (phone && !isValidPhone(phone)) {
        document.getElementById('phone-error').innerText = "Valid phone number is required";
        isValid = false;
    }

    // Validate email address if provided
    if (email && !isValidEmail(email)) {
        document.getElementById('email-error').innerText = "Valid email is required";
        isValid = false;
    }

    // Ensure address is provided
    if (!address) {
        document.getElementById('address-error').innerText = "Address is required";
        isValid = false;
    }

    if (!isValid) {
        showToast("Please fix the errors before saving.", true);
        return; // Stop execution if the form is invalid
    }
    // Equipment validation (optional if you require it)
    if (!equipment) {
        document.getElementById('equipment-error').innerText = "Equipment is required";
        isValid = false;
    }
    // Last Appointment validation (optional if you require it)
    if (!lastAppointment) {
        document.getElementById('last-appointment-error').innerText = "Last Appointment date is required";
        isValid = false;
    }
    // Show loading state while saving the data
    showLoading(true);

    const customerData = {
        name,
        phone,
        email,
        address,
        notes,
        equipment,           // Include equipment field
        lastAppointment,     // Include last appointment field
        createdAt: new Date().toISOString()
    };

    try {
        // Check if we are editing an existing customer or adding a new one
        if (editingCustomerId) {
            await updateDoc(doc(db, "customers", editingCustomerId), customerData);
            showToast("Customer updated!");
        } else {
            await addDoc(customersCollection, customerData);
            showToast("Customer added!");
        }

        // Close the modal and refresh customer data
        document.getElementById('customer-modal').classList.remove('active');
        fetchCustomers();
        resetForm(); // Reset form after successful save
    } catch (error) {
        // Handle errors and show feedback to the user
        showToast(`Failed to save customer: ${error.message}`, true);
        console.error(error);
    } finally {
        // Hide loading state when operation is complete
        showLoading(false);
    }
}
              
            // Delete appointment from Firestore
            async function deleteAppointment(id) {
                if (!confirm("Are you sure you want to delete this appointment?")) return;
                
                showLoading(true);
                try {
                    await deleteDoc(doc(db, "appointments", id));
                    showToast("Appointment deleted successfully");
                    await fetchAppointments();
                } catch (error) {
                    console.error("Error deleting appointment:", error);
                    showToast("Failed to delete appointment", true);
                } finally {
                    showLoading(false);
                }
            }
  
          // Save (add or update) appointment in Firestore
            async function saveAppointment(data) {
                // ✅ Validate required fields
                if (!data.customer) {
                    showToast("Customer name is required", true);
                    return;
                }

                if (!data.phone && !data.email) {
                    showToast("At least one contact (phone or email) is required", true);
                    return;
                    }


                if (!data.date || data.date.toDate?.().toString() === 'Invalid Date') {
                    showToast("Invalid date/time selected", true);
                    return;
                }

                if (!data.equipment) {
                    showToast("Equipment is required", true);
                    return;
                }

                if (data.basePrice == null || isNaN(data.basePrice)) {
                    showToast("Base price is required", true);
                    return;
                }

                if (data.price == null || isNaN(data.price)) {
                    showToast("Total price is required", true);
                    return;
                }

                if (!data.issue) {
                    showToast("Issue description is required", true);
                    return;
                }

                if (!data.status) {
                    showToast("Appointment status is required", true);
                    return;
                }
                if (!data.houseAddress) {
                    showToast("House address is required", true);
                    return;
                }


                showLoading(true);

                try {
                    // 🔧 Create a separate object for notifications only
                    const notificationData = { ...data };
                    notificationData.dateObj = data.date.toDate?.() || new Date();

                    if (editingAppointmentId) {
                        const docRef = doc(db, "appointments", editingAppointmentId);
                        await updateDoc(docRef, data);
                        showToast("Appointment updated successfully");

                        // 🔔 Trigger update notification
                        triggerNotifications('appointment_updated', notificationData);
                    } else {
                        await addDoc(appointmentsCollection, data);
                        showToast("Appointment added successfully");

                        // 🔔 Trigger creation notification
                        console.log("✅ Saving appointment", data);
                        console.log("🧪 About to call triggerNotifications()", notificationData);
                        triggerNotifications('appointment_created', notificationData);
                    }

                    editingAppointmentId = null;
                    await fetchAppointments();
                    document.getElementById('appointment-modal').classList.remove('active');

                } catch (error) {
                    const action = editingAppointmentId ? "updating" : "creating";
                    showToast(`Failed ${action} appointment: ${error.message}`, true);
                    console.error("❌ Error:", error);
                } finally {
                    showLoading(false);
                }
            }

            // ================ RENDERING FUNCTIONS ================
            // Render appointments table
            function renderAppointmentsTable(list = appointments) {
    console.log("Appointments list being passed to render:", list); 
    // Create a filtered appointments list based on the status filter and search query
    let filteredAppointments = [...appointments];

    // Apply status filter
    if (statusFilter !== "All") {
        filteredAppointments = filteredAppointments.filter(app => app.status === statusFilter);
    }

    // Apply search filter if needed
    const searchQuery = document.getElementById('search-appointments')?.value.toLowerCase() || '';
    if (searchQuery) {
        filteredAppointments = filteredAppointments.filter(app => 
            (app.customer?.toLowerCase().includes(searchQuery)) ||
            (app.phone?.includes(searchQuery)) ||
            (app.email?.toLowerCase().includes(searchQuery)) ||
            (app.houseAddress?.toLowerCase().includes(searchQuery))
        );
    }

    const tbody = document.getElementById("appointments-body");
    tbody.innerHTML = ""; // Clear the current table contents

    if (filteredAppointments.length === 0) {
        console.log("No appointments to display."); 
        tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align: center; padding: 30px;">
                    No appointments found
                </td>
            </tr>
        `;
        return;
    }

    // Pagination logic
    const start = (currentPage - 1) * appointmentsPerPage;
    const pageApps = filteredAppointments.slice(start, start + appointmentsPerPage); // Paginate filtered appointments

    // Render appointments
    pageApps.forEach((app) => {
        const statusInfo = statusMap[app.status] || {
            text: app.status || "",
            class: "",
            icon: ""
        };

        const confirmStatus = app.confirmationSentAt
            ? (app.lastAttemptStatus === "success"
                ? "✅"
                : app.lastAttemptStatus === "partial_success"
                    ? "⚠️"
                    : "❌")
            : "⏳";

        const confirmTooltip = {
            "✅": "Confirmation sent successfully",
            "⚠️": app.email
                ? "Partial success (email sent, SMS failed/skipped)"
                : "Partial success (SMS sent, email missing)",
            "❌": "Failed to send confirmation",
            "⏳": "Confirmation not sent yet"
        }[confirmStatus];

        const confirmTimestamp = app.confirmationSentAt
            ? formatTimestamp(app.confirmationSentAt.toDate?.() || new Date())
            : "";

        const isSent = app.confirmationSent;
        const hasChanges = !isSent || app.lastStatusSent !== app.status;
        const canSend = app.needsResend || !app.confirmationSent;
        const row = document.createElement("tr");
        const reminderIcon = app.reminderEnabled ? "🕒" : "";
        const isEdited = !!(app.editedEmailBody || app.editedSmsBody);
        // FIXED: Add unique address to each row
        const encodedAddress = app.houseAddress ? encodeURIComponent(app.houseAddress) : '';
        // ADDED: Directions button column
        row.innerHTML = `
            <td>#${app.id}</td>
            <td>${app.customer}</td>
            <td>${app.equipment || ""}</td>
            <td>${formatTimestamp(app.dateObj)}</td>
            <td>
                <span class="status-badge ${statusInfo.class}" title="${statusInfo.text}">
                    ${statusInfo.icon || ""} ${statusInfo.text}
                </span>
            </td>
            <td>$${(Number(app.price) || 0).toFixed(2)}</td>
            <td>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <span title="${confirmTooltip}" style="font-size: 18px;">${confirmStatus}</span>
                    ${confirmTimestamp ? `<small style="font-size: 11px; color: #ccc;">${confirmTimestamp}</small>` : ""}
                    ${reminderIcon ? `<span title="Reminder enabled">${reminderIcon}</span>` : ""}
                    ${isEdited ? `<span title="Custom message saved" style="font-size: 13px;">✏️</span>` : ""}
                </div>
            </td>
            <td class="action-cell">
                <button class="action-btn send-btn" data-id="${app.id}" title="Send Confirmation" ${canSend ? '' : 'disabled'}>
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="action-btn preview-btn" data-id="${app.id}" title="Preview Email & SMS">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn edit-btn" data-id="${app.id}" aria-label="Edit appointment">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" data-id="${app.id}" aria-label="Delete appointment">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
            <!-- FIXED: Pass appointment-specific address -->
            <td>
                <button class="action-btn directions-btn" 
                        data-id="${app.id}" 
                        data-address="${encodedAddress}" 
                        title="Get Directions">
                    <i class="fas fa-map-marked-alt"></i>
                </button>
            </td>
        `;

        tbody.appendChild(row);
    });

    // Attach button actions
    tbody.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.onclick = () => openEditModal(btn.dataset.id);
    });

    tbody.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.onclick = () => deleteAppointment(btn.dataset.id);
    });

    tbody.querySelectorAll(".send-btn").forEach((btn) => {
        btn.onclick = () => {
            const id = btn.dataset.id;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            showToast("Sending confirmation to customer...");

            fetch("https://cfr-backend-1.onrender.com/api/send-confirmation", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ appointmentId: id, type: "confirmation" })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast("Confirmation sent!");
                    if (data.warnings && data.warnings.length > 0) {
                        data.warnings.forEach(warning => {
                            showToast(warning, true);  // Show as error toast
                        });
                    }
                    fetchAppointments();
                } else {
                    showToast("Failed to send confirmation", "error");
                }
            })
            .catch((err) => {
                console.error("Send confirmation error:", err);
                showToast("Network error while sending", "error");
            });
        };
    });

    tbody.querySelectorAll(".preview-btn").forEach((btn) => {
        btn.onclick = () => {
            const appointment = appointments.find(a => a.id === btn.dataset.id);
            if (appointment) openPreviewModal(appointment);
        };
    });
    
    // ADDED: Directions button handler
  // FIXED: Directions button handler with proper data binding
  tbody.querySelectorAll(".directions-btn").forEach(btn => {
        btn.onclick = () => {
            const address = btn.dataset.address;
            if (address) {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${address}`, '_blank');
            } else {
                showToast('No address available for this appointment', true);
            }
        };
    });
    // Pagination
    const totalPages = Math.ceil(filteredAppointments.length / appointmentsPerPage);
    document.getElementById("page-indicator").textContent = `Page ${currentPage} of ${totalPages || 1}`;
    document.getElementById("prev-page").disabled = currentPage === 1;
    document.getElementById("next-page").disabled = currentPage >= totalPages;
}
        
            // Render customers table
            function renderCustomersTable() {
                const tbody = document.getElementById('customers-body');
                tbody.innerHTML = '';
                
                if (customers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px;">
                                No customers found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                customers.forEach(customer => {
                    const lastAppointment = customer.lastAppointment ? formatDate(customer.lastAppointment) : 'Never';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.equipment || '-'}</td>
                        <td>${customer.lastAppointment || 'Never'}</td>
                        <td class="action-cell">
                            <button class="action-btn edit-btn" data-id="${customer.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${customer.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                // Add click handlers to status cards
            document.querySelectorAll('.status-card').forEach(card => {
                card.addEventListener('click', function() {
                    const status = this.getAttribute('data-status');
                    // Pass status as URL parameter
                    window.location.href = `appointments.html?status=${encodeURIComponent(status)}`;
                });
            });
                // Attach event listeners to each edit/delete button
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => openEditCustomerModal(btn.dataset.id));
                });
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (confirm("Are you sure you want to delete this customer?")) {
                            deleteCustomer(btn.dataset.id);
                        }
                    });
                });
                tbody.querySelectorAll(".send-btn").forEach((btn) => {
    btn.onclick = () => {
        const id = btn.dataset.id;
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        showToast("Sending confirmation...");

        fetch("https://cfr-backend-1.onrender.com/api/send-confirmation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ appointmentId: id, type: "confirmation" })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showToast("Confirmation sent!");
                fetchAppointments();
            } else {
                showToast("Failed to send confirmation", "error");
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-paper-plane"></i>`;
            }
        })
        .catch((err) => {
            console.error("Send confirmation error:", err);
            showToast("Network error while sending", "error");
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-paper-plane"></i>`;
        });
    };
});
            }
            
            // Delete customer
            async function deleteCustomer(id) {
    const customer = customers.find(c => c.id === id);
    if (!customer) return;

    const confirmed = confirm(`Delete customer "${customer.name}" and all their appointments?`);
    if (!confirmed) return;

    showLoading(true);
    try {
        await deleteDoc(doc(db, "customers", id));
        showToast("Customer deleted successfully");
        fetchCustomers();
    } catch (error) {
        showToast("Failed to delete customer", true);
        console.error(error);
    } finally {
        showLoading(false);
    }
}

            
            // Stats update
function updateStats() {
    // Check if appointments is defined and not empty
    if (!appointments || appointments.length === 0) {
        console.log("No appointments available");
        return;
    }

    // Initialize counters
    let total = 0, scheduled = 0, inProgress = 0, completed = 0;
    
    // Iterate over appointments once and count each status
    appointments.forEach(app => {
        total++; // Every appointment counts as a total
        if (app.status === "Scheduled / Confirmed") scheduled++;
        if (app.status === "In Progress") inProgress++;
        if (app.status === "Completed") completed++;
    });

    // Update counts on the page
    document.getElementById("total-appointments").textContent = total;
    document.getElementById("scheduled-count").textContent = scheduled;
    document.getElementById("inprogress-count").textContent = inProgress;
    document.getElementById("released-count").textContent = completed;

    // Update footer text
    document.getElementById('total-appointments-text').textContent = `${total} appointments`;
    document.getElementById('scheduled-text').textContent = `${scheduled} scheduled`;
    document.getElementById('inprogress-text').textContent = `${inProgress} in progress`;
    document.getElementById('completed-text').textContent = `${completed} completed`;
}
  
            // Calendar rendering and summary
            function renderCalendar() {
                // Only render if calendar is visible
                if (!document.getElementById('calendar-view').classList.contains('active')) {
                    return;
                }
                const settings = JSON.parse(localStorage.getItem('fitnessRepairSettings') || '{}');
                const holidays = getCanadianHolidays(currentYear, settings.province || 'ON');
                const calendarGrid = document.getElementById("calendar-days");
                calendarGrid.innerHTML = "";
                
                const monthNames = ["January", "February", "March", "April", "May", "June",
                  "July", "August", "September", "October", "November", "December"];
                
                document.getElementById("current-month-year").textContent = 
                    `${monthNames[currentMonth]} ${currentYear}`;
                
                const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                daysOfWeek.forEach((day) => {
                    const dayHeader = document.createElement("div");
                    dayHeader.className = "calendar-day-header";
                    dayHeader.textContent = day;
                    calendarGrid.appendChild(dayHeader);
                });
                
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement("div");
                    emptyCell.className = "calendar-day empty";
                    calendarGrid.appendChild(emptyCell);
                }
                
                for (let day = 1; day <= totalDays; day++) {
                    const dayCell = document.createElement("div");
                    dayCell.className = "calendar-day";
                    
                    // Check if holiday
                    const isHoliday = Object.values(holidays).some(holiday => 
                        holiday.getDate() === day && 
                        holiday.getMonth() === currentMonth
                    );
                    
                    if (isHoliday) {
                        dayCell.classList.add('holiday');
                    }
                    
                    const dayNumber = document.createElement("div");
                    dayNumber.className = "day-number";
                    dayNumber.textContent = day;
                    dayCell.appendChild(dayNumber);
                    
                    // Get appointments for this day
                    const dayApps = appointments.filter(app => {
                        if (!app.dateObj) return false;
                        const d = app.dateObj;
                        return d.getDate() === day && 
                               d.getMonth() === currentMonth && 
                               d.getFullYear() === currentYear;
                    });
                    
                    if (dayApps.length > 0) {
                        const container = document.createElement("div");
                        container.className = "calendar-appointments";
                        
                        dayApps.forEach(app => {
                            const item = document.createElement("div");
                            item.className = "appointment-item";
                            item.dataset.id = app.id;
                            const time = app.dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            item.textContent = `${app.customer.split(" ")[0]} - ${time}`;
                            container.appendChild(item);
                        });
                        
                        dayCell.appendChild(container);
                    }
                    
                    calendarGrid.appendChild(dayCell);
                }
            }
            function setupCalendarEventHandlers() {
                document.querySelectorAll('.appointment-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const appointmentId = e.currentTarget.dataset.id;
                        showAppointmentDetails(appointmentId);
                    });
                });
            }
            function showAppointmentDetails(id) {
                const appointment = appointments.find(a => a.id === id);
                if (!appointment) return;
    
                const modalContent = `
                    <h3>Appointment Details</h3>
                    <p><strong>Customer:</strong> ${appointment.customer}</p>
                    <p><strong>Date:</strong> ${formatTimestamp(appointment.dateObj)}</p>
                    <p><strong>Equipment:</strong> ${appointment.equipment}</p>
                    <p><strong>Status:</strong> ${statusMap[appointment.status]?.text || 'N/A'}</p>
                    <p><strong>Issue:</strong> ${appointment.issue}</p>
                    <p><strong>Base Price:</strong> $${(appointment.basePrice || 0).toFixed(2)}</p>
                    <p><strong>Tax:</strong> $${((appointment.price || 0) - (appointment.basePrice || 0)).toFixed(2)}</p>
                    <p><strong>Total Price:</strong> $${totalPrice.toFixed(2)}</p>
                    <button class="btn" id="edit-details">Edit Appointment</button>
                `;
    
                openDetailsModal(modalContent, id);
                // Attach the edit logic AFTER the modal opens
                setTimeout(() => {
                    const btn = document.getElementById('edit-details');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            // Manually close the Appointment Details modal
                            const detailsModal = document.querySelector('.modal-overlay.active');
                            if (detailsModal) {
                                detailsModal.classList.remove('active');
                            }
    
                            // Switch to the Appointments view tab
                            activateView("appointments");
    
                            // Wait for view to load, then open the edit form
                            setTimeout(() => {
                                openEditModal(id);
                            }, 100);
                        });
                    }
                }, 50);
            }
            function exportAppointmentsCSV() {
  if (!appointments || appointments.length === 0) {
    showToast("No appointments to export", true);
    return;
  }

  const headers = ['ID', 'Customer', 'Phone', 'Date', 'Equipment', 'Status', 'Price'];
  const csvContent = [
    headers.join(','),
    ...appointments.map(a => [
      a.id,
      `"${a.customer}"`,
      a.phone || '',
      a.dateObj?.toISOString() || '',
      `"${a.equipment}"`,
      a.status || '',
      a.price || ''
    ].join(','))
  ].join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `appointments-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // ✅ Success toast
  showToast("✅ Appointments exported as CSV");
}
            function isTomorrow(date) {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);

                return (
                    date.getFullYear() === tomorrow.getFullYear() &&
                    date.getMonth() === tomorrow.getMonth() &&
                    date.getDate() === tomorrow.getDate()
                );
                }

                function updateCalendarSummary() {
    // Get appointments for current month
    const monthlyApps = appointments.filter(app => {
        const appDate = app.dateObj;
        return appDate.getMonth() === currentMonth && 
               appDate.getFullYear() === currentYear;
    });

    // Get completed appointments using consistent status filter
    const completedAppointments = monthlyApps.filter(app => 
        app.status === "Completed"  // Use the same status string everywhere
    );

    // Calculate total revenue
    const totalRevenue = completedAppointments.reduce((sum, app) => {
        // Handle different price formats
        const price = typeof app.price === 'string' ? 
            parseFloat(app.price.replace(/[^0-9.]/g, '')) : 
            app.price;
            
        return sum + (price || 0);
    }, 0);

    const businessDays = getBusinessDays(currentMonth, currentYear);
    
    // Update all elements consistently
    document.getElementById("summary-total").textContent = monthlyApps.length;
    document.getElementById("summary-days").textContent = businessDays;
    document.getElementById('summary-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
    document.getElementById('monthly-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
    document.getElementById('monthly-released').textContent = completedAppointments.length;
    const currentAppointments = monthlyApps.filter(app => app.status !== "Completed");
    document.getElementById("current-appointments").textContent = currentAppointments.length;

    const utilizationRate = Math.min(100, Math.round((monthlyApps.length / (businessDays * 3)) * 100));
    document.getElementById("summary-utilization").textContent = utilizationRate + "%";
}
            
            
            window.addEventListener('DOMContentLoaded', async () => {
  await fetchAppointments(); // ✅ Make sure appointments are loaded
  checkUpcomingAppointments(); // ✅ Run reminder logic after fetch
});
            document.getElementById("prev-log-page").addEventListener("click", () => {
            if (currentLogPage > 1) {
                currentLogPage--;
                renderLogsPage();
            }
            });
            document.addEventListener("geomap:address-selected", function (e) {
    const result = e.detail;

    // Fill hidden input with selected address
    document.getElementById("house-address-input").value = result.full_address;

    // Optional: display distance
    if (result.distance_km !== undefined) {
      document.getElementById("geomap-distance").textContent = result.distance_km.toFixed(2);
    }

    // Clear validation error
    const errorBox = document.getElementById("house-address-error");
    if (errorBox) errorBox.textContent = "";
  });
            document.getElementById("next-log-page").addEventListener("click", () => {
  const totalPages = Math.ceil(allLogs.length / logsPerPage);
  if (currentLogPage < totalPages) {
    currentLogPage++;
    renderLogsPage();
  }
});
            document.addEventListener("DOMContentLoaded", () => {
  document.querySelector(".close-modal").addEventListener("click", closePreviewModal);
});
                document.addEventListener('DOMContentLoaded', () => {
                loadGoogleMapsApi()
                    .then(() => initAutocomplete())
                    .catch(error => {
                    console.error('Google Maps API failed to load:', error);
                    });
                });
                // Dashboard card navigation
                document.getElementById('total-appointments-card').addEventListener('click', () => {
                    activateView('appointments');
                });

                document.getElementById('scheduled-card').addEventListener('click', () => {
                    activateView('appointments');
                    // Optional: Filter to show only scheduled appointments
                });

                document.getElementById('inprogress-card').addEventListener('click', () => {
                    activateView('appointments');
                    // Optional: Filter to show only in-progress appointments
                });

                document.getElementById('completed-card').addEventListener('click', () => {
                    activateView('appointments');
                    // Optional: Filter to show only completed appointments
                });
            
                window.addEventListener('DOMContentLoaded', () => {
  const distanceSpan = document.getElementById('gomaps-distance');

  // Assuming GoMaps triggers a custom event "gomaps:addressSelected"
  // with detail containing the distance (in km) or lat/lon to calculate it

  document.getElementById('gomaps-widget').addEventListener('gomaps:addressSelected', (e) => {
    // e.detail.distanceKm is assumed distance in kilometers
    if (e.detail && typeof e.detail.distanceKm === 'number') {
      distanceSpan.textContent = e.detail.distanceKm.toFixed(2);
    }
  });
});

            
            
                // Chart.js setup
                function initChart() {
    const ctx = document.getElementById("appointmentsChart").getContext("2d");

    if (chartInstance) {
        chartInstance.destroy();
    }

    const counts = {
        scheduled: appointments.filter(a => a.status === "Scheduled / Confirmed").length,
        in_progress: appointments.filter(a => a.status === "In Progress").length,
        completed: appointments.filter(a => a.status === "Completed").length,
        cancelled: appointments.filter(a => a.status === "Cancelled").length,
    };

    chartInstance = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: ["Scheduled", "In Progress", "Completed", "Cancelled"],
            datasets: [{
                data: Object.values(counts),
                backgroundColor: [
                    "rgba(93, 93, 255, 0.7)",
                    "rgba(52, 152, 219, 0.7)",
                    "rgba(46, 204, 113, 0.7)",
                    "rgba(231, 76, 60, 0.7)",
                ],
                borderColor: [
                    "rgba(93, 93, 255, 1)",
                    "rgba(52, 152, 219, 1)",
                    "rgba(46, 204, 113, 1)",
                    "rgba(231, 76, 60, 1)",
                ],
                borderWidth: 1,
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: "right",
                    labels: { color: "#e5e7eb", font: { size: 12 } },
                },
                title: {
                    display: true,
                    text: "Appointment Status Distribution",
                    color: "#e5e7eb",
                    font: { size: 16 },
                },
            },
        },
    });
}

            // ================ MODAL MANAGEMENT ================
            function openEditModal(id) {
    document.getElementById('toast-container').innerHTML = '';

    const app = appointments.find((a) => a.id === id);
    if (!app) return;

    editingAppointmentId = id;

    // 🧠 Store original values to detect changes
    const dateObj = app.dateObj || new Date();
    const dateStr = dateObj.toISOString().split("T")[0];
    const timeStr = dateObj.toTimeString().slice(0, 5);
    originalAppointmentData = {
        date: dateStr,
        time: timeStr,
        status: app.status || ""
    };

    // Clear validation & set values
    document.querySelectorAll('.validation-error').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.form-control').forEach(field => field.classList.remove('invalid'));

    document.getElementById("customer-name").value = app.customer;
    document.getElementById("customer-phone").value = app.phone || "";
    document.getElementById("customer-email").value = app.email || "";
    document.getElementById("customer-carrier").value = app.carrier || "unknown";
    document.getElementById("appointment-date").value = dateStr;
    document.getElementById("appointment-time").value = timeStr;
    document.getElementById("equipment").value = app.equipment || "";
    document.getElementById("appointment-base-price").value = app.basePrice || app.price || 0;
    document.getElementById("issue-description").value = app.issue || "";
    document.getElementById("repair-notes").value = app.repair_notes || "";
    document.getElementById("appointment-status").value = app.status || "";
    document.getElementById("reminder-enabled").checked = app.reminderEnabled || false;
    document.getElementById("reminder-enabled").checked = !!app.reminderEnabled;
    document.getElementById("house-address-input").value = app.houseAddress || "";


    calculateTax();

    document.getElementById("modal-title").textContent = "Edit Appointment";
    document.getElementById("save-appointment").textContent = "Update Appointment";
    document.getElementById('appointment-modal').classList.add('active');
}
document.addEventListener('DOMContentLoaded', function() {
    fetchAppointments();
    setupStatusCardClickHandlers(); // ✅ this is good
});


            function openAddModal() {
                  // Clear existing toasts
                document.getElementById('toast-container').innerHTML = '';
                  // Clear validation states
                const fields = document.querySelectorAll('#appointment-form .form-control');
                fields.forEach(field => {
                    field.classList.remove('invalid');
                    const errorId = `${field.id}-error`;
                    const errorElement = document.getElementById(errorId);
                    if (errorElement) errorElement.textContent = '';
                });
                editingAppointmentId = null;
                
                // Reset form and set default values
                document.getElementById("appointment-form").reset();
                    // ✅ Clear house address separately
    document.getElementById("house-address-input").value = "";
                // Clear validation errors
                document.querySelectorAll('.validation-error').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.form-control').forEach(field => {
                    field.classList.remove('invalid');
                });
                
                const today = new Date();
                document.getElementById("appointment-date").value = today.toISOString().split("T")[0];
                
                const nextHour = new Date(today.getTime() + 60 * 60 * 1000);
                document.getElementById("appointment-time").value = 
                    `${nextHour.getHours().toString().padStart(2, "0")}:${nextHour.getMinutes().toString().padStart(2, "0")}`;
                
                document.getElementById("appointment-base-price").value = 150;
                calculateTax(); // Calculate initial tax
                
                // Update modal title
                document.getElementById("modal-title").innerHTML = 
                    '<i class="fas fa-calendar-plus"></i> Add New Appointment';
                
                // Show modal
                document.getElementById('appointment-modal').classList.add('active');
            }        
                
    function closeAppointmentModal() {
                document.getElementById('appointment-modal').classList.remove('active');
            }
            
            function openAddCustomerModal() {
                editingCustomerId = null;
                document.getElementById('customer-form').reset();
                
                // Update modal title
                document.getElementById("customer-modal-title").innerHTML = 
                    '<i class="fas fa-user-plus"></i> Add New Customer';
                
                // Show modal
                document.getElementById('customer-modal').classList.add('active');
            }  
            function openEditCustomerModal(id) {
                const customer = customers.find(c => c.id === id);
                if (!customer) return;
                
                editingCustomerId = id;
                document.getElementById('customer-modal-name').value = customer.name || '';
                document.getElementById('customer-modal-phone').value = customer.phone || '';
                document.getElementById('customer-modal-email').value = customer.email || '';
                document.getElementById('customer-modal-address').value = customer.address || '';
                document.getElementById('customer-modal-notes').value = customer.notes || '';
                document.getElementById('customer-modal-equipment').value = customer.equipment || '';  // New field for equipment
                document.getElementById('customer-modal-last-appointment').value = customer.lastAppointment || '';  // New field for last appointment
                document.getElementById('customer-modal-title').textContent = "Edit Customer";
                document.getElementById('customer-modal').classList.add('active');
            }
            async function updateAppointmentField(id, data) {
  const db = firebase.firestore();
  await db.collection("appointments").doc(id).update(data);
}
           
            function closeCustomerModal() {
                document.getElementById('customer-modal').classList.remove('active');
            }
            
            // ================ EVENT LISTENERS ================
            function setupEventListeners() {
                // Sidebar navigation
                document.querySelectorAll(".nav-links a").forEach(link => {
                    link.addEventListener("click", (e) => {
                        e.preventDefault();
                        const view = link.dataset.view;
                        activateView(view);
                    });
                });
                
                document.querySelectorAll(".nav-links a").forEach(link => {
                    link.addEventListener("click", (e) => {
                        e.preventDefault();
                        const view = link.dataset.view;
                        activateView(view);
                        
                        // Auto-close sidebar on mobile
                        if (window.innerWidth <= 576) {
                            document.querySelector('.sidebar').classList.remove('active');
                        }
                    });
                });
    
                // Logout button
                document.querySelector('.nav-links a[data-view="logout"]').addEventListener("click", (e) => {
                    e.preventDefault();
                    logout();
                });
                // View switcher for sidebar links (including logs)
document.querySelectorAll('[data-view]').forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const view = link.getAttribute('data-view');
    activateView(view);
  });
});
                // Top tab navigation
                document.querySelectorAll(".tab").forEach(tab => {
                    tab.addEventListener("click", () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        activateView(tab.dataset.tab);
                    });
                });
                
                // Month navigation buttons
                document.getElementById("prev-month").addEventListener("click", () => {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    renderCalendar();
                    updateCalendarSummary();
                });
                
                document.getElementById("next-month").addEventListener("click", () => {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    renderCalendar();
                    updateCalendarSummary();
                });
                
                // Appointment pagination
                document.getElementById("prev-page").addEventListener("click", () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderAppointmentsTable();
                    }
                });
                
                document.getElementById("next-page").addEventListener("click", () => {
                    const totalPages = Math.ceil(appointments.length / appointmentsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderAppointmentsTable();
                    }
                });
                
                // Search functionality
                document.getElementById("search-appointments").addEventListener("input", function () {
                    const keyword = this.value.toLowerCase();
                    const filtered = appointments.filter(
                        (app) => app.customer.toLowerCase().includes(keyword) ||
                                 (app.phone && app.phone.toLowerCase().includes(keyword))
                    );
                    currentPage = 1;
                    renderAppointmentsTable(filtered);
                });
                
                // Print button
                document.getElementById("print-schedule").addEventListener("click", () => {
                    window.print();
                });
                document.getElementById('export-appointments').addEventListener('click', exportAppointmentsCSV);

                // Add tax calculation to base price input
                const basePriceInput = document.getElementById('appointment-base-price');
                if (basePriceInput) {
                    basePriceInput.addEventListener('input', calculateTax);
                }
                
                // Add appointment button
                document.getElementById("add-appointment").addEventListener("click", openAddModal);
                
                document.getElementById("save-appointment").addEventListener("click", async () => {
    const customerName = document.getElementById("customer-name").value.trim();
    const phone = document.getElementById("customer-phone").value.trim();
    const email = document.getElementById("customer-email")?.value?.trim() || "";
    const houseAddress = document.getElementById("house-address-input").value.trim();
    if (!houseAddress) {
        showValidationError('house-address-input', 'House address is required');
        return;
        }
    const carrier = (document.getElementById("customer-carrier")?.value || "").toLowerCase();
                    
    if (!phone && !email) {
        alert("Please enter at least a phone number or email address.");
        return;
    }

    const dateInput = document.getElementById("appointment-date").value;
    const timeInput = document.getElementById("appointment-time").value;
    const dateObj = new Date(`${dateInput}T${timeInput}`);
    const timestamp = Timestamp.fromDate(dateObj);
    const equipment = document.getElementById("equipment").value.trim();
    const basePrice = parseFloat(document.getElementById("appointment-base-price").value) || 0;
    const issue = document.getElementById("issue-description").value.trim();
    const status = document.getElementById("appointment-status").value;
    const repairNotes = document.getElementById("repair-notes").value.trim();
    const settings = JSON.parse(localStorage.getItem('fitnessRepairSettings') || '{}');
    const province = settings.province || 'ON';
    const taxRate = getTaxRate(province);
    const totalPrice = parseFloat((basePrice * (1 + taxRate)).toFixed(2));


    // 🔍 Compare with original values
    const hasChanges =
        editingAppointmentId &&
        (dateInput !== originalAppointmentData.date ||
         timeInput !== originalAppointmentData.time ||
         status !== originalAppointmentData.status);
         const reminderEnabled = document.getElementById("reminder-enabled").checked;
       
         const appointmentData = {
        customer: customerName,
        phone,
        email,
        carrier,
        equipment,
        houseAddress: houseAddress,
        date: timestamp,
        basePrice,
        price: totalPrice,
        taxRate,
        issue,
        status,
        repair_notes: repairNotes,
        createdAt: Timestamp.now(),
        createdBy: auth.currentUser.uid,
        confirmationSent: false,
        confirmationSentAt: null,
        lastStatusSent: "",
        lastAttemptStatus: "",
        reminderEnabled,
        needsResend: hasChanges  // ✅ flag if changed
    };
    console.log("📝 Saving appointment:", appointmentData);
    await saveAppointment(appointmentData);
});


                // Modal controls
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        closeAppointmentModal();
                        closeCustomerModal();
                    });
                });
                document.querySelector('.main-content').addEventListener('click', function(e) {
    const card = e.target.closest('.card-grid .card');
    if (card) {
    const status = card.getAttribute('data-status');
    if (status) {
        // Update statusFilter (Ensure this is declared somewhere in your code)
        statusFilter = status;

        // Correct the ID to appointment-status
        const statusDropdown = document.getElementById('appointment-status');

        // Ensure statusDropdown exists before setting its value
        if (statusDropdown) {
            statusDropdown.value = status;
            activateView("appointments");
        } else {
            console.error('Status dropdown not found');
        }
    }
}
});
                document.getElementById("cancel-appointment").addEventListener("click", closeAppointmentModal);
                
                // Customer modals
                document.getElementById('add-customer').addEventListener('click', openAddCustomerModal);
                document.getElementById('save-customer').addEventListener('click', saveCustomer);
                document.getElementById('cancel-customer').addEventListener('click', closeCustomerModal);
                document.getElementById('search-appointments').addEventListener('input', function() {
    renderAppointmentsTable();
});
                // Mobile menu toggle
                const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
                const sidebar = document.querySelector('.sidebar');
                const closeSidebarBtn = document.querySelector('.close-sidebar-mobile');
                // Add mobile close functionality
                document.querySelector('.close-sidebar-mobile')?.addEventListener('click', () => {
                    document.querySelector('.sidebar').classList.remove('active');
                });
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
                
                // Close sidebar when close button is clicked
                closeSidebarBtn?.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                });
                
                // Add this in setupEventListeners()
                const saveSettingsBtn = document.getElementById('save-settings');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }   
                const cancelSettingsBtn = document.getElementById('cancel-settings');
                if (cancelSettingsBtn) {
                    cancelSettingsBtn.addEventListener('click', () => {
                        loadSettings(); // Revert form to saved values
                        showToast("Changes reverted");
                    });
                }        
    }

    document.getElementById('lookup-carrier')?.addEventListener('click', async () => {
  const phone = document.getElementById('customer-phone')?.value?.trim();
  if (!phone) return alert("Please enter a phone number first");

  try {
    // 📋 Copy to clipboard
    await navigator.clipboard.writeText(phone);
    alert("Phone number copied to clipboard. You can now paste it into the search box.");

    // 🌐 Open freecarrierlookup search page
    window.open("https://freecarrierlookup.com/", "_blank");
  } catch (err) {
    console.error("Clipboard error:", err);
    alert("Failed to copy phone number.");
  }
});

    window.addEventListener('DOMContentLoaded', function () {
        // Use setInterval to repeatedly check if 'status-filter' exists
        const checkStatusFilter = setInterval(function() {
            const statusFilter = document.getElementById('appointment-status');
           console.log("Current statusFilter:", statusFilter);  // Add this line for debugging


            if (statusFilter) {
                // Stop checking once it's found
                clearInterval(checkStatusFilter); 

                // Add event listener for change event
                statusFilter.addEventListener('change', function () {
                    const selectedStatus = this.value;
                    const url = selectedStatus === 'All'
                        ? 'appointments.html'
                        : `appointments.html?status=${encodeURIComponent(selectedStatus)}`;
                    window.history.pushState({}, '', url);
                    fetchAppointments(); // Assuming fetchAppointments is defined elsewhere
                });
            }
        }, 100); // Check every 100ms
    });

    document.addEventListener("DOMContentLoaded", () => {
  if (typeof GoMaps !== "undefined") {
    GoMaps.init({
      widgetId: "gomaps-widget",
      apiKey: "AlzaSyT7Sa-m79jL64rRoxfdkn7k6wlFRwiJX0c",
      outputId: "house-address-input",
      distanceFrom: "22 Canary Grass Blvd, Hamilton, Ontario, L0R 1P0",
      mapHeight: "200px",
      showMap: true,
      label: "Start typing your address..."
    });
  } else {
    console.error("GoMaps script not loaded");
  }
});


  // Add to setupEventListeners()
    document.getElementById('test-sms-btn')?.addEventListener('click', sendTestSMS);
    
    function sendTestSMS() {
        // Get current settings
        const settings = JSON.parse(localStorage.getItem('fitnessRepairSettings') || '{}');
        
        // Check if settings are saved
        if (!settings.adminPhone || !settings.smsCarrier) {
            showToast("Please save your phone and carrier settings first", true);
            return;
        }
        
        // Create test appointment data
        const testAppointment = {
            customer: "Test User",
            dateObj: new Date(),
            id: "test-123"
        };
        
        // Show sending notification
        showToast("Sending test SMS...");
        
        // Send test notification
        sendSMSNotification('test', testAppointment);
    }
    document.addEventListener("DOMContentLoaded", function() {
    // Add event listener for the reset button
    document.getElementById('reset-customer').addEventListener('click', resetForm);
});

            // ================ INITIALIZATION ================
            function initialize() {
                setupEventListeners();
                activateView('dashboard');
                
                // Set current date for appointment form
                const today = new Date();
                document.getElementById("appointment-date").value = today.toISOString().split("T")[0];
                
                const nextHour = new Date(today.getTime() + 60 * 60 * 1000);
                document.getElementById("appointment-time").value = 
                    `${nextHour.getHours().toString().padStart(2, "0")}:${nextHour.getMinutes().toString().padStart(2, "0")}`;
                
                // Initialize form validation
                initializeValidation();
                
                // Hide loading overlay after 1.5s
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 1500);
            }
            
            // Start the application
            initialize();
        }
        function openDetailsModal(content, id) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    ${content}
                </div>
            `;
            document.body.appendChild(modal);
    
            // Close button
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.remove();
            });
    
            // Edit button logic
            modal.querySelector('#edit-details')?.addEventListener('click', () => {
                modal.remove();
                if (typeof openEditModal === "function") {
                    openEditModal(id); // ID comes from argument
                }
            });
        }
    </script>
  <script src="https://cdn.gomaps.pro/autocomplete/gomaps-autocomplete.min.js"></script>
</body>
</html>
